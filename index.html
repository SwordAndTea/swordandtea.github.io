<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://SwordAndTea.github.io').hostname,
    root: '/',
    scheme: 'Pisces',
    version: '7.7.1',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: true,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="xiangwei&#39;s blog">
<meta property="og:url" content="http://swordandtea.github.io/index.html">
<meta property="og:site_name" content="xiangwei&#39;s blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="SwordAndTea">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://swordandtea.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>xiangwei's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">xiangwei's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://swordandtea.github.io/2025/05/24/others/prose-mirror/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="SwordAndTea">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiangwei's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2025/05/24/others/prose-mirror/" class="post-title-link" itemprop="url">prose-mirror</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-05-24 11:31:06" itemprop="dateCreated datePublished" datetime="2025-05-24T11:31:06-04:00">2025-05-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-25 13:08:09" itemprop="dateModified" datetime="2025-05-25T13:08:09-04:00">2025-05-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ProseMirror/" itemprop="url" rel="index">
                    <span itemprop="name">ProseMirror</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>3.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://prosemirror.net/docs/guide/">ProseMirror Guide</a></p>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>There are four essential modules, which are required to do any editing at all</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model"><code>prosemirror-model</code></a> defines the editor’s <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/guide/#doc">document model</a>, the data structure used to describe the content of the editor.</li>
</ul>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#state"><code>prosemirror-state</code></a> provides the data structure that describes the editor’s whole state, including the selection, and a transaction system for moving from one state to the next.</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#view"><code>prosemirror-view</code></a> implements a user interface component that shows a given editor state as an editable element in the browser, and handles user interaction with that element.</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#transform"><code>prosemirror-transform</code></a> contains functionality for modifying documents in a way that can be recorded and replayed, which is the basis for the transactions in the <code>state</code> module, and which makes the undo history and collaborative editing possible.</p>
</li>
</ul>
<font color="orange">ProseMirror requires you to specify a schema that your document conforms to,  that schema is then used to create a state, which will generate an empty document conforming to the schema,  and a default selection at the start of that document.</font>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;schema&#125; <span class="keyword">from</span> <span class="string">&quot;prosemirror-schema-basic&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123;EditorState&#125; <span class="keyword">from</span> <span class="string">&quot;prosemirror-state&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123;EditorView&#125; <span class="keyword">from</span> <span class="string">&quot;prosemirror-view&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> state = EditorState.create(&#123;schema&#125;)</span><br><span class="line"><span class="keyword">let</span> view = <span class="keyword">new</span> EditorView(<span class="built_in">document</span>.body, &#123;state&#125;)</span><br></pre></td></tr></table></figure>
<h1 id="Transactions"><a href="#Transactions" class="headerlink" title="Transactions"></a>Transactions</h1><p>When the user types, or otherwise interacts with the view, it generates ‘state transactions’.  What that means is that it does not just modify the document in-place and implicitly update its state in that way.  Instead, <font color="orange">every change causes a transaction to be created, which describes the changes that are made to the state,  and can be applied to create a new state, which is then used to update the view</font>.  <font color="pink">By default this all happens under the cover</font>, but you can hook into by writing plugins or configuring your view.</p>
<h1 id="Plugins"><a href="#Plugins" class="headerlink" title="Plugins"></a>Plugins</h1><p>Plugins are used to extend the behavior of the editor and editor state in various ways.</p>
<h1 id="Command"><a href="#Command" class="headerlink" title="Command"></a>Command</h1><p>Most editing actions are written as commands which can be bound to keys, hooked up to menus, or otherwise exposed to the user.</p>
<h1 id="Content"><a href="#Content" class="headerlink" title="Content"></a>Content</h1><p>A state’s document lives under its <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#state.EditorState.doc"><code>doc</code></a> property. This is a <font color="orange">read-only data structure</font>, representing the document as a hierarchy of nodes, somewhat like the browser DOM. A simple document might be a <code>&quot;doc&quot;</code> node containing two <code>&quot;paragraph&quot;</code> nodes, each containing a single <code>&quot;text&quot;</code> node.</p>
<p>When initializing a state, you can give it an initial document to use. In that case, the <code>schema</code> field is optional, since the schema can be taken from the document.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;DOMParser&#125; <span class="keyword">from</span> <span class="string">&quot;prosemirror-model&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123;EditorState&#125; <span class="keyword">from</span> <span class="string">&quot;prosemirror-state&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123;schema&#125; <span class="keyword">from</span> <span class="string">&quot;prosemirror-schema-basic&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> content = <span class="built_in">document</span>.getElementById(<span class="string">&quot;content&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> state = EditorState.create(&#123;</span><br><span class="line">  doc: DOMParser.fromSchema(schema).parse(content)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h1 id="Documents"><a href="#Documents" class="headerlink" title="Documents"></a>Documents</h1><h2 id="structure"><a href="#structure" class="headerlink" title="structure"></a>structure</h2><p>A ProseMirror document is a <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.Node">node</a>, which holds a <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.Fragment">fragment</a> containing zero or more child nodes.<br>This is a lot like the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model">browser DOM</a>, in that it is recursive and tree-shaped. <font color="orange">But it differs from the DOM in the way it stores inline content. Whereas in ProseMirror, the inline content is modeled as a flat sequence, with the markup attached as metadata to the nodes</font>.</p>
<p><img src="/2025/05/24/others/prose-mirror/document-structure.png" alt></p>
<font color="pink">Adjacent text nodes with the same set of marks are always combined together, and empty text nodes are not allowed. The order in which marks appear is specified by the schema.</font>

<h2 id="Identity-and-persistence"><a href="#Identity-and-persistence" class="headerlink" title="Identity and persistence"></a><font color="pink">Identity and persistence</font></h2><p> In the DOM, nodes are mutable objects with an <em>identity</em>, which means that a node can only appear in one parent node, and that the node object is mutated when it is updated.</p>
<font color="orange">In ProseMirror, on the other hand, nodes are simply *values* that can appear in multiple data structures at the same time, it does not have a parent-link to the data structure it is currently part of</font>.

So it is with pieces of ProseMirror documents. They don't change, but can be used as a starting value to compute a modified piece of document. They don't know what data structures they are part of, but can be part of multiple structures, or even occur multiple times in a single structure. They are *values*, not stateful objects.

<font color="orange">This means that every time you update a document, you get a new document value. That document value will share all sub-nodes that didn't change with the original document value, making it relatively cheap to create.</font>

<p>This has a bunch of advantages. It makes it impossible to have an editor in an invalid in-between state during an update, since the new state, with a new document, can be swapped in instantaneously. It also makes it easier to reason about documents in a somewhat mathematical way, which is really hard if your values keep changing underneath you. This helps make collaborative editing possible and allows ProseMirror to run a very efficient DOM <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#view.EditorView.update">update</a> algorithm by comparing the last document it drew to the screen to the current document.</p>
<h2 id="Data-structures"><a href="#Data-structures" class="headerlink" title="Data structures"></a>Data structures</h2><p><img src="/2025/05/24/others/prose-mirror/node-structure.png" title alt data-align="center"></p>
<p>The content of a node is stored in an instance of <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.Fragment"><code>Fragment</code></a>, which holds a sequence of nodes. Even for nodes that don’t have or don’t allow content, this field is filled (with the shared <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.Fragment%5Eempty">empty fragment</a>).<br>Some node types allow <font color="orange">attributes, which are extra values stored with each node</font>. For example, an image node might use these to store its alt text and the URL of the image.</p>
<p>In addition, inline nodes hold a set of active marks—things like emphasis or being a link—which are represented as an array of <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.Mark"><code>Mark</code></a> instances.</p>
<font color="pink">A full document is just a node. The document content is represented as the top-level node's child nodes</font>.

<font color="orange">What kind of node is allowed where is determined by the document's [schema](https://prosemirror.net/docs/guide/#schema)</font>. To programmatically create nodes, you must go through the schema, for example using the [`node`](https://prosemirror.net/docs/ref/#model.Schema.node) and [`text`](https://prosemirror.net/docs/ref/#model.Schema.text) methods.

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;schema&#125; <span class="keyword">from</span> <span class="string">&quot;prosemirror-schema-basic&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// (The null arguments are where you can specify attributes, if necessary.)</span></span><br><span class="line"><span class="keyword">let</span> docNode = schema.node(<span class="string">&quot;doc&quot;</span>, <span class="literal">null</span>, [</span><br><span class="line">  schema.node(<span class="string">&quot;paragraph&quot;</span>, <span class="literal">null</span>, [schema.text(<span class="string">&quot;One.&quot;</span>)]),</span><br><span class="line">  schema.node(<span class="string">&quot;horizontal_rule&quot;</span>),</span><br><span class="line">  schema.node(<span class="string">&quot;paragraph&quot;</span>, <span class="literal">null</span>, [schema.text(<span class="string">&quot;Two!&quot;</span>)])</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

## Indexing

ProseMirror nodes support two types of indexing—they can be treated as trees, using offsets into individual nodes, or they can be treated as a flat sequence of tokens.
<font color="orange">The first allows you to do things similar to what you'd do with the DOM</font>—interacting with single nodes, directly accessing child nodes using the [`child` method](https://prosemirror.net/docs/ref/#model.Node.child) and [`childCount`](https://prosemirror.net/docs/ref/#model.Node.childCount), writing recursive functions that scan through a document (if you just want to look at all nodes, use [`descendants`](https://prosemirror.net/docs/ref/#model.Node.descendants) or [`nodesBetween`](https://prosemirror.net/docs/ref/#model.Node.nodesBetween)).
<font color="orange">The second is more useful when addressing a specific position in the document</font>. It allows any document position to be represented as an integer—the index in the token sequence. These tokens don't actually exist as objects in memory—they are just a counting convention—but the document's tree shape, along with the fact that each node knows its size, is used to make by-position access cheap.

Take care to distinguish between child indices (as per [`childCount`](https://prosemirror.net/docs/ref/#model.Node.childCount)), document-wide positions, and node-local offsets (sometimes used in recursive functions to represent a position into the node that's currently being handled).

## Slices

To handle things like copy-paste and drag-drop, it is necessary to be able to talk about a slice of document, i.e. the content between two positions. Such a slice differs from a full node or fragment in that some of the nodes at its start or end may be ‘open’. For example, if you select from the middle of one paragraph to the middle of the next one, the slice you've selected has two paragraphs in it

## Changing

Most of the time, you'll use [transformations](https://prosemirror.net/docs/guide/#transform) to update documents, and won't have to directly touch the nodes. These also leave a record of the changes, which is necessary when the document is part of an editor state.

# <font color="orange">Schemas</font>

<p>Each ProseMirror <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/guide/#doc">document</a> has a <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.Schema">schema</a> associated with it. The schema describes the kind of <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.Node">nodes</a> that may occur in the document, and the way they are nested. For example, it might say that the top-level node can contain one or more blocks, and that paragraph nodes can contain any number of inline nodes, with any <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.Mark">marks</a> applied to them.</p>
<h2 id="Node-Types"><a href="#Node-Types" class="headerlink" title="Node Types"></a>Node Types</h2><p>Every node in a document has a <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.NodeType">type</a>, which represents its semantic meaning and its properties, such as the way it is rendered in the editor.</p>
<p>When you define a schema, you enumerate the node types that may occur within it, describing each with a <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.NodeSpec">spec object</a>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> trivialSchema = <span class="keyword">new</span> Schema(&#123;</span><br><span class="line">  nodes: &#123;</span><br><span class="line">    doc: &#123;<span class="attr">content</span>: <span class="string">&quot;paragraph+&quot;</span>&#125;,</span><br><span class="line">    paragraph: &#123;<span class="attr">content</span>: <span class="string">&quot;text*&quot;</span>&#125;,</span><br><span class="line">    text: &#123;<span class="attr">inline</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">    <span class="comment">/* ... and so on */</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>Every schema must at least define a top-level node type (which defaults to the name <code>&quot;doc&quot;</code>, but you can <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.Schema.topNodeType">configure</a> that), and a <code>&quot;text&quot;</code> type for text content.</p>
<h2 id="Content-Expressions"><a href="#Content-Expressions" class="headerlink" title="Content Expressions"></a><font color="pink">Content Expressions</font></h2><p>The strings in the <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.NodeSpec.content"><code>content</code></a> fields in the example schema above are called <em>content expressions</em>. They control what sequences of child nodes are valid for this node type.</p>
<p>For example <code>&quot;paragraph&quot;</code> for “one paragraph”, or <code>&quot;paragraph+&quot;</code> to express “one or more paragraphs”. Similarly, <code>&quot;paragraph*&quot;</code> means “zero or more paragraphs” and <code>&quot;caption?&quot;</code> means “zero or one caption node”. You can also use regular-expression-like ranges, such as <code>&#123;2&#125;</code> (“exactly two”) <code>&#123;1, 5&#125;</code> (“one to five”) or <code>&#123;2,&#125;</code> (“two or more”) after node names.</p>
<p>Such expressions can be combined to create a sequence, for example <code>&quot;heading paragraph+&quot;</code> means ‘first a heading, then one or more paragraphs’. You can also use the pipe <code>|</code> operator to indicate a choice between two expressions, as in <code>&quot;(paragraph | blockquote)+&quot;</code>.<br>Some groups of element types will appear multiple times in your schema—for example you might have a concept of “block” nodes, that may appear at the top level but also nested inside of blockquotes. You can create a node group by giving your node specs a <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.NodeSpec.group"><code>group</code></a> property, and then refer to that group by its name in your expressions.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> groupSchema = <span class="keyword">new</span> Schema(&#123;</span><br><span class="line">  nodes: &#123;</span><br><span class="line">    doc: &#123;<span class="attr">content</span>: <span class="string">&quot;block+&quot;</span>&#125;,</span><br><span class="line">    paragraph: &#123;<span class="attr">group</span>: <span class="string">&quot;block&quot;</span>, <span class="attr">content</span>: <span class="string">&quot;text*&quot;</span>&#125;,</span><br><span class="line">    blockquote: &#123;<span class="attr">group</span>: <span class="string">&quot;block&quot;</span>, <span class="attr">content</span>: <span class="string">&quot;block+&quot;</span>&#125;,</span><br><span class="line">    text: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Here <code>&quot;block+&quot;</code> is equivalent to <code>&quot;(paragraph | blockquote)+&quot;</code>.</p>
<p><font color="orange">It is recommended to always require at least one child node in nodes that have block content (such as <code>&quot;doc&quot;</code> and <code>&quot;blockquote&quot;</code> in the example above), because browsers will completely collapse the node when it’s empty, making it rather hard to edit</font>.</p>
<p>The order in which your nodes appear in an or-expression is significant.</p>
<h2 id="Marks"><a href="#Marks" class="headerlink" title="Marks"></a>Marks</h2><p>Marks are used to add extra styling or other information to inline content. A schema must declare all mark types it allows in its <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.Schema">schema</a>. <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.MarkType">Mark types</a> are objects much like node types, used to tag mark objects and provide additional information about them.</p>
<p><font color="orange">By default, nodes with inline content allow all marks defined in the schema to be applied to their children. You can configure this with the <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.NodeSpec.marks"><code>marks</code></a> property on your node spec</font>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> markSchema = <span class="keyword">new</span> Schema(&#123;</span><br><span class="line">  nodes: &#123;</span><br><span class="line">    doc: &#123;<span class="attr">content</span>: <span class="string">&quot;block+&quot;</span>&#125;,</span><br><span class="line">    paragraph: &#123;<span class="attr">group</span>: <span class="string">&quot;block&quot;</span>, <span class="attr">content</span>: <span class="string">&quot;text*&quot;</span>, <span class="attr">marks</span>: <span class="string">&quot;_&quot;</span>&#125;,</span><br><span class="line">    heading: &#123;<span class="attr">group</span>: <span class="string">&quot;block&quot;</span>, <span class="attr">content</span>: <span class="string">&quot;text*&quot;</span>, <span class="attr">marks</span>: <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">    text: &#123;<span class="attr">inline</span>: <span class="literal">true</span>&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  marks: &#123;</span><br><span class="line">    strong: &#123;&#125;,</span><br><span class="line">    em: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>The set of marks is interpreted as a space-separated string of mark names or mark groups—<code>&quot;_&quot;</code> acts as a wildcard, and the empty string corresponds to the empty set.</p>
<h2 id="Attributes"><a href="#Attributes" class="headerlink" title="Attributes"></a>Attributes</h2><p>The document schema also defines which <em>attributes</em> each node or mark has. If your node type requires extra node-specific information to be stored, such as the level of a heading node, that is best done with an attribute.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">heading: &#123;</span><br><span class="line">    content: <span class="string">&quot;text*&quot;</span>,</span><br><span class="line">    attrs: &#123;<span class="attr">level</span>: &#123;<span class="attr">default</span>: <span class="number">1</span>&#125;&#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>In this schema, every instance of the <code>heading</code> node will have a <code>level</code> attribute under <code>.attrs.level</code>. If it isn’t specified when the node is <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.NodeType.create">created</a>, it will default to 1.<br>When you don’t give a default value for an attribute, an error will be raised when you attempt to create such a node without specifying that attribute.</p>
<h2 id="Serialization-and-Parsing"><a href="#Serialization-and-Parsing" class="headerlink" title="Serialization and Parsing"></a>Serialization and Parsing</h2><p>In order to be able to edit them in the browser, it must be possible to represent document nodes in the browser DOM. The easiest way to do that is to include information about each node’s DOM representation in the schema using the <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.NodeSpec.toDOM"><code>toDOM</code> field</a> in the node spec.</p>
<p>Documents also come with a built-in JSON serialization format. You can call <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.Node.toJSON"><code>toJSON</code></a> on them to get an object that can safely be passed to <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify"><code>JSON.stringify</code></a>, and schema objects have a <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.Schema.nodeFromJSON"><code>nodeFromJSON</code> method</a> that can parse this representation back into a document.</p>
<h2 id="Extending-a-schema"><a href="#Extending-a-schema" class="headerlink" title="Extending a schema"></a>Extending a schema</h2><p>The <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#schema-list">schema-list</a> module exports a <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#schema-list.addListNodes">convenience method</a> to add the nodes exported by those modules to a nodeset.</p>
<h1 id="Document-transformations"><a href="#Document-transformations" class="headerlink" title="Document transformations"></a>Document transformations</h1><p><a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#transform.Transform">Transforms</a> are central to the way ProseMirror works. They form the basis for <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/guide/#state.transactions">transactions</a>, and are what makes history tracking and collaborative editing possible.</p>
<h2 id="Steps"><a href="#Steps" class="headerlink" title="Steps"></a>Steps</h2><p>Updates to documents are decomposed into <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#transform.Step">steps</a> that describe an update. <font color="orange">You usually don’t need to work with these directly</font>, but it is useful to know how they work. Examples of steps are <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#transform.ReplaceStep"><code>ReplaceStep</code></a> to replace a piece of a document, or <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#transform.AddMarkStep"><code>AddMarkStep</code></a> to add a mark to a given range.</p>
<p> applying a step can fail, for example if you try to delete just the opening token of a node, that would leave the tokens unbalanced, which isn’t a meaningful thing you can do. This is why <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#transform.Step.apply"><code>apply</code></a> returns a <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#transform.StepResult">result object</a>, which holds either a new document, <em>or</em> an error message. You’ll usually want to let <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#transform.Transform.replace">helper functions</a> generate your steps for you, so that you don’t have to worry about the details.</p>
<h2 id="Transforms"><a href="#Transforms" class="headerlink" title="Transforms"></a>Transforms</h2><p>An editing action may produce one or more steps. The most convenient way to work with a sequence of steps is to create a <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#transform.Transform"><code>Transform</code> object</a> (or, if you’re working with a full editor state, a <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#state.Transaction"><code>Transaction</code></a>, which is a subclass of <code>Transform</code>).</p>
<h2 id="Rebasing"><a href="#Rebasing" class="headerlink" title="Rebasing"></a>Rebasing</h2><p>When doing more complicated things with steps and position maps, for example to implement your own change tracking, or to integrate some feature with collaborative editing, you might run into the need to <em>rebase</em> steps.</p>
<p>You might not want to bother studying this until you are sure you need it.</p>
<h1 id="The-editor-state"><a href="#The-editor-state" class="headerlink" title="The editor state"></a>The editor state</h1><p>What makes up the state of an editor? You have your document, of course. And also the current selection. And there needs to be a way to store the fact that the current set of marks has changed, when you for example disable or enable a mark but haven’t started typing with that mark yet.<br>Those are the three main components of a ProseMirror state, and exist on state objects as <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#state.EditorState.doc"><code>doc</code></a>, <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#state.EditorState.selection"><code>selection</code></a>, and <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#state.EditorState.storedMarks"><code>storedMarks</code></a>.</p>
<h2 id="Selection"><a href="#Selection" class="headerlink" title="Selection"></a>Selection</h2><p>Selections are represented by instances of (subclasses of) the <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#state.Selection"><code>Selection</code></a> class. Like documents and other state-related values, they are immutable—to change the selection, you create a new selection object and a new state to hold it.</p>
<p>Selections have, at the very least, a start (<a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#state.Selection.from"><code>.from</code></a>) and an end (<a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#state.Selection.to"><code>.to</code></a>), as positions pointing into the current document. Many selection types also distinguish between the <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#state.Selection.anchor"><em>anchor</em></a> (unmoveable) and <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#state.Selection.head"><em>head</em></a> (moveable) side of the selection, so those are also required to exist on every selection object.</p>
<h2 id="Transactions-1"><a href="#Transactions-1" class="headerlink" title="Transactions"></a>Transactions</h2><p>State updates happen by <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#state.EditorState.apply">applying</a> a <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#state.Transaction">transaction</a> to an existing state, producing a new state. Conceptually, they happen in a single shot: given the old state and the transaction, a new value is computed for each component of the state, and those are put together in a new state value.<br><a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#state.Transaction"><code>Transaction</code></a> is a subclass of <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#transform.Transform"><code>Transform</code></a>, and inherits the way it builds up a new document by applying <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#transform.Step">steps</a> to an initial document. In addition to this, transactions track selection and other state-related components, and get some selection-related convenience methods such as <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#state.Transaction.replaceSelection"><code>replaceSelection</code></a>.</p>
<h2 id="Plugin"><a href="#Plugin" class="headerlink" title="Plugin"></a>Plugin</h2><p>When <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#state.EditorState%5Ecreate">creating</a> a new state, you can provide an array of plugins to use. These will be stored in the state and any state that is derived from it, and can influence both the way transactions are applied and the way an editor based on this state behaves.</p>
<p>Plugins are instances of the <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#state.Plugin"><code>Plugin</code> class</a>, and can model a wide variety of features. The simplest ones just add some <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#view.EditorProps">props</a> to the editor view, for example to respond to certain events. More complicated ones might add new state to the editor and update it based on transactions.</p>
<p>When creating a plugin, you pass it <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#state.PluginSpec">an object</a> specifying its behavior:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myPlugin = <span class="keyword">new</span> Plugin(&#123;</span><br><span class="line">  props: &#123;</span><br><span class="line">    <span class="function"><span class="title">handleKeyDown</span>(<span class="params">view, event</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;A key was pressed!&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span> <span class="comment">// We did not handle this</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h1 id="The-view-componet"><a href="#The-view-componet" class="headerlink" title="The view componet"></a>The view componet</h1><p>A ProseMirror <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#view.EditorView">editor view</a> is a user interface component that displays an <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/guide/#state">editor state</a> to the user, and allows them to perform editing actions on it.</p>
<p>The definition of <em>editing actions</em> used by the core view component is rather narrow—it handles direct interaction with the editing surface, such as typing, clicking, copying, pasting, and dragging, but not much beyond that. This means that things like displaying a menu, or even providing a full set of key bindings, lie outside of the responsibility of the core view component, and have to be arranged through plugins.</p>
<h2 id="Editable-DOM"><a href="#Editable-DOM" class="headerlink" title="Editable DOM"></a>Editable DOM</h2><p>Browsers allow us to specify that some parts of the DOM are <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/contentEditable">editable</a>, which has the effect of allowing focus and a selection in them, and making it possible to type into them. The view creates a DOM representation of its document (using your schema’s <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#model.NodeSpec.toDOM"><code>toDOM</code> methods</a> by default), and makes it editable. When the editable element is focused, ProseMirror makes sure that the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Selection">DOM selection</a> corresponds to the selection in the editor state.</p>
<p>most cursor-motion related keys and mouse actions are handled by the browser, after which ProseMirror checks what kind of <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#state.TextSelection">text selection</a> the current DOM selection would correspond to. If that selection is different from the current selection, a transaction that updates the selection is dispatched.</p>
<p>Even typing is usually left to the browser, because interfering with that tends to break spell-checking, autocapitalizing on some mobile interfaces, and other native features. When the browser updates the DOM, the editor notices, re-parses the changed part of the document, and translates the difference into a transaction.</p>
<h2 id="Data-flow"><a href="#Data-flow" class="headerlink" title="Data flow"></a>Data flow</h2><p><img src="/2025/05/24/others/prose-mirror/data-flow.png" alt></p>
<h2 id="Efficient-updating"><a href="#Efficient-updating" class="headerlink" title="Efficient updating"></a>Efficient updating</h2><p>One way to implement <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#view.EditorView.updateState"><code>updateState</code></a> would be to simply redraw the document every time it is called. But for large documents, that would be really slow.<br>Since, at the time of updating, the view has access to both the old document and the new, it can compare them, and leave the parts of the DOM that correspond to unchanged nodes alone. ProseMirror does this, allowing it to do very little work for typical updates.</p>
<h1 id="Commands"><a href="#Commands" class="headerlink" title="Commands"></a>Commands</h1><p>In ProseMirror jargon, a <em>command</em> is a function that implements an editing action, which the user can perform by pressing some key combination or interacting with the menu.</p>
<p>The <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#commands"><code>prosemirror-commands</code></a> module provides a number of editing commands, from simple ones such as a variant of the <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#commands.deleteSelection"><code>deleteSelection</code></a> command, to rather complicated ones such as <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#commands.joinBackward"><code>joinBackward</code></a>, which implements the block-joining behavior that should happen when you press backspace at the start of a textblock. It also comes with a <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#commands.baseKeymap">basic keymap</a> that binds a number of schema-agnostic commands to the keys that are usually used for them.</p>
<p>When possible, different behavior, even when usually bound to a single key, is put in different commands. The utility function <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/ref/#commands.chainCommands"><code>chainCommands</code></a> can be used to combine a number of commands—they will be tried one after the other until one return true.</p>
<h2 id="Collaborative-editing"><a href="#Collaborative-editing" class="headerlink" title="Collaborative editing"></a>Collaborative editing</h2><p>Real-time collaborative editing allows multiple people to edit the same document at the same time. Changes they make are applied immediately to their local document, and then sent to peers, which merge in these changes automatically.</p>
<h2 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h2><p>ProseMirror’s collaborative editing system employs a central authority which determines in which order changes are applied. If two editors make changes concurrently, they will both go to this authority with their changes. The authority will accept the changes from one of them, and broadcast these changes to all editors. The other’s changes will not be accepted, and when that editor receives new changes from the server, it’ll have to <a target="_blank" rel="noopener" href="https://prosemirror.net/docs/guide/#transform.rebasing">rebase</a> its local changes on top of those from the other editor, and try to submit them again.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://swordandtea.github.io/2025/02/02/cloud_computing/aws/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="SwordAndTea">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiangwei's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2025/02/02/cloud_computing/aws/" class="post-title-link" itemprop="url">aws</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-02-02 17:46:28" itemprop="dateCreated datePublished" datetime="2025-02-02T17:46:28-05:00">2025-02-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-02-05 19:18:31" itemprop="dateModified" datetime="2025-02-05T19:18:31-05:00">2025-02-05</time>
              </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>202</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="VPC"><a href="#VPC" class="headerlink" title="VPC"></a>VPC</h1><h2 id="Internet-Gateway"><a href="#Internet-Gateway" class="headerlink" title="Internet Gateway"></a>Internet Gateway</h2><p>internet gateway is responsible for connection between resources under vpc with public ips and the internet.</p>
<h3 id="Subnet"><a href="#Subnet" class="headerlink" title="Subnet"></a>Subnet</h3><p>differnet Subnets can associate different Route Tables, <font color="orange">if the subnet associated a route table with a destination to Internet Gateway, this subnet can be considered as public subnet</font>.</p>
<h2 id="NAT"><a href="#NAT" class="headerlink" title="NAT"></a>NAT</h2><p>NAT is responsible for connection between resources under vpc only with private ips and the internet. It’s a one way connection, only the private resource can reach the external internet, the external internet can not reach the private resource with NAT. <font color="orange">The NAT need to bind a Elastic IP, which is a public IP, hence, the NAT need to be defined in a public subnet</font> (the subnet has a route table item to Internet Gateway).</p>
<h2 id="Load-balancer"><a href="#Load-balancer" class="headerlink" title="Load balancer"></a>Load balancer</h2><p>Load balancer is like the reverse version of NAT, it support external network traffic to going into internal public and private resources if it’s a internet facing load balancer. Normally internet facing load balancer will have public IP address, those address can be seem in ENI(Elastic Network Interfaces).</p>
<p>Load balancer essential is a nginx, it can create routing rules to different target group and add ssl certificate</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://swordandtea.github.io/2024/11/04/machine_learning/d2l-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="SwordAndTea">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiangwei's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/04/machine_learning/d2l-summary/" class="post-title-link" itemprop="url">d2l-summary</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-04 08:45:34" itemprop="dateCreated datePublished" datetime="2024-11-04T08:45:34-05:00">2024-11-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-30 14:31:52" itemprop="dateModified" datetime="2024-11-30T14:31:52-05:00">2024-11-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/machine-learning/" itemprop="url" rel="index">
                    <span itemprop="name">machine learning</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>10 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Preliminaries"><a href="#Preliminaries" class="headerlink" title="Preliminaries"></a>Preliminaries</h1><h2 id="Data-Preprocessing"><a href="#Data-Preprocessing" class="headerlink" title="Data Preprocessing"></a>Data Preprocessing</h2><p>In real life data, usually there will be missing values. Depending upon the context, missing values might be handled either via imputation or deletion.</p>
<ul>
<li><p>Imputation: replaces missing values with estimates of their values</p>
</li>
<li><p>Deletion: simply discards either those rows or those columns that contain missing values.</p>
</li>
</ul>
<h1 id="Linear-Model"><a href="#Linear-Model" class="headerlink" title="Linear Model"></a>Linear Model</h1><h2 id="Linear-Regression"><a href="#Linear-Regression" class="headerlink" title="Linear Regression"></a>Linear Regression</h2><p>Leanr Regression Model can be represented as $\hat{y} = Xw + b$, where $X$ is in the shape of $[\text{batch_size}, \text{num_features}]$, $w$ is in the shape of $[\text{num_features}, 1]$, b is a scale value. Correspondingly, $\hat{y}$ is in the shape of $[\text{batch_size}, 1]$</p>
<p>Linear Regression Model usually use <strong>Mean Square Loss</strong> as loss function</p>
<font color="orange">Linear Regression Model as analytic solution</font>, which is $w^{*} = (X^{T}X)^{-1}X^{T}y$

## Logistic Regression

Logistic Regression is a binary classification model. Basicaly, it adds a sigmoid function on the output of Leaner Regression Model, $\sigma(x) = \frac{1}{1 + e^{-x}}$, the output value is bounded to $[0, 1]$

## Softmax Regression

Softmax Regression is a multi-classification model. In the final layer, there will be multiple output nodes which normally will be the same as the number of classes. For the output nodes, we apply softmax function: 

$$
\hat{y} = softmax(o) \space \text{where} \space \hat{y_i} = \frac{exp(o_i)}{\sum_{j}exp(o_j)}
$$

The output value of softmax can be treated as the probability. For the label, we use **one-hot encoding** and use **Cross Entropy Loss**:

$$
l(y, \hat{y}) = -\sum_{j=1}^{q} y_i \log \hat{y_i}
$$

# Accuracy of Classification Model

accuracy is simple way to evaluate the performance of classification model, it is simply calculated by the number of right perdiction divide by the number of total predictions.

# MLP

Multilayer Perceptrons is based on linear model with hidden layers and activation functions. <font color="orange">The activation functions is to introduce nonlinear to the model</font>. If there is no activation function, the MLP will still be a linear model. Usually, we use `ReLU` as activation function.

# Dropout

Dropout is a method to prevent overfitting. Dropout will random set some paramater value of a layer to zero with probability of $p$, and in order to keep the the distribution of the data unshifted, we need to scale those remain parameter to $\frac{h}{1-p}$. 

<font color="orange">Dropout is usuallly applied after activation functions</font>.

<font color="orange">Dropout is only used during training steps, there will be no drop out in inference step</font>.

# Weight Decay

Like Dropout, Weight Decay is a way to prevent overfitting. It is basically add $l2$ penalty to the **loss function**, it is defined as

$$
\frac{\lambda}{2}||W||^2
$$

$\lambda$ is called **Weight Decay Rate**. In pytorch, weight decay is set upon optimizer.

# CNN

# Convolutional Operation

In the two-dimensional Convolutional(cross-correlation) operation, we begin with the convolution window positioned at the upper-left corner of the input tensor and slide it across the input tensor, both from left to right and top to bottom. When the convolution window slides to a certain position, the input subtensor contained in that window and the kernel tensor are multiplied elementwise and the resulting tensor is summed up yielding a single scalar value.

For input tensor with size $n_h \times n_w$ and convultional kernal size $k_h \times k_w$, the output tensor size is $(n_h - k_h + 1) \times (n_w - k_w +1)$

For a convolutional Layer, it usually <font color="orange">has bias parameter</font> like the linear model. The size of bias parameter is number of output channel.

The kernal can be learned based on input value and output value.

The output tensor of the convolutional layer is also called feature map. In the deep cnn neural network, the feature map close to the data input usually has smaller receptive field, representing some local spatial features(i.e. edges, corners). While the feature map in deep layer usually has larger receptive field, representing gobal spatial features or semantic features(i.e class information).

## Padding and Stride

* padding: the convolutional op will reduce tensor size, in order to keep the size unchanged, we can padding zeros around the input, if the kernel size is $k_h \times k_w$, usually, we will padding $(k_h - 1) / 2$ on top and bottom, padding $(k_w - 1)/2$ on left and right. <font color="orange">Hence, we often use odd sized convolutional kernel</font>.

* stride: stride is mainly used for reduce tensor size. Defaultly, convolutional layer use stride of 1, which means the kernel window moves one element next after the convolutional operation. stride size can be set both in height and width. Usually, we will set stride to 2 to downsampling the tensor size to half both in height and width.

## Pooling

* max pooling: output the max value in the kernel area
* average pooling: output the avage value in the kernel area

Pooling layer has no learning parameter. 

<font color="orange">In Deep CNNs, the Convolutional Layer usually will use padding to keep the height and width unchanged but extend output channels to double. While Pooling Layer is usually set with stride equal to 2 to half the width and height. </font>

<font color="orange">In pytorch, the stride size by default is equal to kernel size</font>.

## Multiple Input Output Channels

usually image has three channels(rgb) and for a convolutional layer, it can have multiple output channels. 

If the input channels is $c_i$ and output channels is 1, then we need $c_i$ cnn kernels, <font color="orange">the result will be the sum of convolutional(cross-correlation) operation result of input channel $i$ and convolutional kernal $i$</font>. Correspondingly, if the input channels is $c_i$ and output channels is $c_o$, the there will be $c_i \cdot c_o$ number of cnn kernels

<font color="orange">The channel dimension can be considered as the feature dimension of convolutional nerual network</font>

<h2 id="LeNet"><a href="#LeNet" class="headerlink" title="LeNet"></a>LeNet</h2><p>The first Deep CNN.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">self.net = nn.Sequential(</span><br><span class="line">            nn.LazyConv2d(<span class="number">6</span>, kernel_size=<span class="number">5</span>, padding=<span class="number">2</span>), </span><br><span class="line">            nn.Sigmoid(),</span><br><span class="line">            nn.AvgPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>),</span><br><span class="line"></span><br><span class="line">            nn.Conv2d(<span class="number">6</span>, <span class="number">16</span>, kernel_size=<span class="number">5</span>), </span><br><span class="line">            nn.Sigmoid(),</span><br><span class="line">            nn.AvgPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>),</span><br><span class="line"></span><br><span class="line">            nn.Flatten(),</span><br><span class="line"></span><br><span class="line">            nn.LazyLinear(<span class="number">120</span>),</span><br><span class="line">            nn.Sigmoid(),</span><br><span class="line"></span><br><span class="line">            nn.Linear(<span class="number">120</span>, <span class="number">84</span>),</span><br><span class="line">            nn.Sigmoid(),</span><br><span class="line"></span><br><span class="line">            nn.Linear(<span class="number">84</span>, num_classes)</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<h1 id="Modern-CNN"><a href="#Modern-CNN" class="headerlink" title="Modern CNN"></a>Modern CNN</h1><h2 id="AlexNet"><a href="#AlexNet" class="headerlink" title="AlexNet"></a>AlexNet</h2><p>AlexNet is basically a bigger and deep version of LeNet.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">self.net = nn.Sequential(</span><br><span class="line">            nn.LazyConv2d(<span class="number">96</span>, kernel_size=<span class="number">11</span>, stride=<span class="number">4</span>, padding=<span class="number">1</span>),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.MaxPool2d(<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line"></span><br><span class="line">            nn.Conv2d(<span class="number">96</span>, <span class="number">256</span>, kernel_size=<span class="number">5</span>, padding=<span class="number">2</span>),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.MaxPool2d(<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line"></span><br><span class="line">            nn.Conv2d(<span class="number">256</span>, <span class="number">384</span>, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line"></span><br><span class="line">            nn.Conv2d(<span class="number">384</span>, <span class="number">384</span>, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line"></span><br><span class="line">            nn.Conv2d(<span class="number">384</span>, <span class="number">256</span>, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.MaxPool2d(<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line"></span><br><span class="line">            nn.Flatten(),</span><br><span class="line"></span><br><span class="line">            nn.LazyLinear(<span class="number">4096</span>),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.Dropout(<span class="number">0.5</span>),</span><br><span class="line"></span><br><span class="line">            nn.Linear(<span class="number">4096</span>, <span class="number">4096</span>),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.Dropout(<span class="number">0.5</span>),</span><br><span class="line"></span><br><span class="line">            nn.Linear(<span class="number">4096</span>, num_classes)</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<h2 id="VGG"><a href="#VGG" class="headerlink" title="VGG"></a>VGG</h2><p>VGG provide a general template to design convolutional nerual network which is use net blocks. In VGG, the layers in a  block are basic Conv Layer, Activation Layer and Pooling Layer</p>
<p>block code</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vgg_block</span>(<span class="params">num_convs, out_channels</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    @param num_convs: number of convolutional layers</span></span><br><span class="line"><span class="string">    @param out_channels: number of output channels, the channel num will be </span></span><br><span class="line"><span class="string">        changed immediately in the first conv layer</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    layers = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_convs):</span><br><span class="line">        layers.append(nn.LazyConv2d(out_channels, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>))</span><br><span class="line">        layers.append(nn.ReLU())</span><br><span class="line"></span><br><span class="line">    layers.append(nn.MaxPool2d(<span class="number">2</span>, stride=<span class="number">2</span>))</span><br><span class="line">    <span class="keyword">return</span> nn.Sequential(*layers)</span><br></pre></td></tr></table></figure>
<p>net structure</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">conv_blocks = []</span><br><span class="line"><span class="keyword">for</span> (num_convs, out_channels) <span class="keyword">in</span> arch:</span><br><span class="line">    conv_blocks.append(vgg_block(num_convs, out_channels))</span><br><span class="line"></span><br><span class="line">    self.net = nn.Sequential(</span><br><span class="line">        *conv_blocks,</span><br><span class="line"></span><br><span class="line">        nn.Flatten(),</span><br><span class="line"></span><br><span class="line">        nn.LazyLinear(<span class="number">4096</span>),</span><br><span class="line">        nn.ReLU(),</span><br><span class="line">        nn.Dropout(<span class="number">0.5</span>),</span><br><span class="line"></span><br><span class="line">        nn.Linear(<span class="number">4096</span>, <span class="number">4096</span>),</span><br><span class="line">        nn.ReLU(),</span><br><span class="line">        nn.Dropout(<span class="number">0.5</span>),</span><br><span class="line"></span><br><span class="line">        nn.Linear(<span class="number">4096</span>, num_classes)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<h2 id="NiN-Network-in-Network"><a href="#NiN-Network-in-Network" class="headerlink" title="NiN(Network in Network)"></a>NiN(Network in Network)</h2><p>NiN Replaces the Full Connect Layers in CNN with Global Avg Pool, which significant reduces training parameters.</p>
<p>NiN block:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nin_block</span>(<span class="params">out_channels, kernel_size, stride, padding</span>):</span></span><br><span class="line">    block = nn.Sequential(</span><br><span class="line">        nn.LazyConv2d(out_channels, kernel_size=kernel_size, stride=stride, padding=padding),</span><br><span class="line">        nn.ReLU(),</span><br><span class="line"></span><br><span class="line">        nn.Conv2d(out_channels, out_channels, kernel_size=<span class="number">1</span>),</span><br><span class="line">        nn.ReLU(),</span><br><span class="line"></span><br><span class="line">        nn.Conv2d(out_channels, out_channels, kernel_size=<span class="number">1</span>),</span><br><span class="line">        nn.ReLU()</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> block</span><br></pre></td></tr></table></figure>
<p>NiN net structure</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">self.net = nn.Sequential(</span><br><span class="line">            nin_block(<span class="number">96</span>, kernel_size=<span class="number">11</span>, stride=<span class="number">4</span>, padding=<span class="number">0</span>),</span><br><span class="line">            nn.MaxPool2d(<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line"></span><br><span class="line">            nin_block(<span class="number">256</span>, kernel_size=<span class="number">5</span>, stride=<span class="number">1</span>, padding=<span class="number">2</span>),</span><br><span class="line">            nn.MaxPool2d(<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line"></span><br><span class="line">            nin_block(<span class="number">384</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>),</span><br><span class="line">            nn.MaxPool2d(<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line"></span><br><span class="line">            <span class="comment"># nn.Dropout in cnn will random drop some pixel at every channel</span></span><br><span class="line">            <span class="comment"># nn.dropout2d in cnn will drop some entire channels</span></span><br><span class="line">            nn.Dropout(<span class="number">0.5</span>),</span><br><span class="line"></span><br><span class="line">            <span class="comment"># import here: we reduce channels to number of classes</span></span><br><span class="line">            nin_block(num_classes, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>),</span><br><span class="line">            <span class="comment"># adaptive pool will make the result height and width to the target size</span></span><br><span class="line">            nn.AdaptiveAvgPool2d((<span class="number">1</span>, <span class="number">1</span>)),</span><br><span class="line"></span><br><span class="line">            nn.Flatten()</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<h2 id="GoogLeNet"><a href="#GoogLeNet" class="headerlink" title="GoogLeNet"></a>GoogLeNet</h2><p>GoogLeNet designed a multi-branch structure called <strong>Inception Block</strong></p>
<p><img src="/2024/11/04/machine_learning/d2l-summary/inception-block.png" alt> </p>
<p>for the input, it use different size of convolutional kernels to extract new features and contact the result of all branchs in <font color="orange">feature dimension</font>. In order to do contatenation sucessfully, the output height and width of each branch should be the same. </p>
<p>The each branch in inception block keep the height and width the same as the input. While during blocks, it use pooling layer to half height and width.</p>
<p>Moreover, in the final layer, it use a single full connect layer simply to match the output with number of classes.</p>
<p>GoogLeNet structure: </p>
<p><img src="/2024/11/04/machine_learning/d2l-summary/GoogLeNet.png" alt></p>
<h2 id="ResNet"><a href="#ResNet" class="headerlink" title="ResNet"></a>ResNet</h2><p>ResNet is a net that will add input back into output for each block</p>
<p><img title src="/2024/11/04/machine_learning/d2l-summary/resnet-block.png" alt data-align="center"></p>
<font color="orange">In order to add input and output successfully, the number of channels, width and height should all be the same</font>. So, normally, we will use 1x1 convolutional kernel to do some transform on the input.

The resnet-18 architecture:

![](./d2l-summary/resnet18.png)

## ResNeXt Block

ResNeXt Block use a grouped convolution to speed up calculation of convolutional block. In a convolutional layer with out grouped convolution, if the input channel is $c_i$ and the output channel is $c_o$, the computational cost of this layer is proportional to $O(c_i \cdot c_o)$. If we use grouped convolution, we will split the input channels into $g$ groups, so, for each group, the input channel size is $\frac{c_i}{g}$, and we output $\frac{c_o}{g}$ number of channels for every group. Then we contact the outputs from all groups into $c_o$ channels. Hence, after grouped convolution, the computational cost for each group is $O(\frac{c_i}{g} \cdot \frac{c_o}{g})$, and the computational cost of the total group is $O(g \cdot \frac{c_i}{g} \cdot \frac{c_o}{g})=O(\frac{c_i \cdot c_o}{g})$. So, If the group size is $g$, then the speed is theoretically g times faster.

![](./d2l-summary/resNeXt-block.png)

## DenseNet

DenseNet like ResNet, will utilize the input in each convolutional block (dense block), but instead of add the input with the output elementwisely, <font color="orange">it concat the input and output in channel dimension</font>.

![](./d2l-summary/densenet.png)

As for the dense block, it consists of multiple convolution blocks, each using the same number of output channels. <font color="orange">And in order to enable concatation with input and output in channel dimension, the dense block convolutional layers will keep the width and height unchanged</font>.

Since each dense block will increase the number of channels, adding too many of them will lead to an excessively complex model. A transition layer is used to control the complexity of the model. It reduces the number of channels by using a 1x1 convolution. Moreover, it halves the height and width via average pooling with a stride of 2.

# Batch Normalization

Batch Normalization is a technique to accelerate the convergence of deep neural network. It is defined as:

$$
BN(X) = \gamma \odot \frac{x- \hat{\mu_{B}}}{\hat{\sigma_{B}}} + \beta
$$

Where $\mu_{B}$ is the sample mean and $\sigma_{B}$ is the sample standard deviation of the minibatch $B$, 

Batch Normalization <font color="orange">has training parameter</font> $\gamma$ and $\beta$. After applying standardization, the resulting minibatch has zero mean and unit variance. The choice of unit variance (rather than some other magic number) is arbitrary. We recover this degree of freedom by including an elementwise scale parameter $\gamma$ and shift parameter $\beta$.  <font color="orange">Batch Normalization will be used both in training process and inference process, but during the two phases, it has different behaviors</font>. During train phase, the mean and variance is calculated with a batch of data, meanwhile, we accumulate the mean amd variance of the whole training data with momentum. Then during inference phase, we apply the learn $\gamma$, $\beta$, and the accumulated mean and variance to calculate the output of the Batch Normalization Layer.

Basically, Batch Normalization will first normalize the batch data to mean equal to 0 and variance equal to 1 <font color="orange">for each feature</font>, then shift the data to mean equal to $\gamma$ and variance to $\beta$. 

Because Batch Normalization calculates mean and variance among a batch of data, the <font color="orange">batch size parameter has a significant influence on the Batch Normalization</font>.

Usually, Batch Normalization layer is applied after Convolutional Layer and before activation function.

# Layer Normalization

The difference of Layer Normalization and Batch Normalization is that Layer Norm calculate mean and variance based on <font color="orange">a single data among all features</font>, while Batch Normalization calculate mean and variance based on a single feature among a batch of data. Hence, Layer Normalization is not sensitive to batch size we choose. <font color="orange">In addition, layer normalization has no learning parameters</font>.

Layer Normalization is often used in transformer for vision like ViT net.

# Computer Vision

## Image Augmentation

## Fine-Tuning

## Single Shot Multibox Detection

## R-CNNS



# RNN

## Raw Test into Sequence Data

* Tokenize the raw text and build a vocabulary

  * token is the atomic(indivisible) units of text, the simplest way is to tokenize text by characters or words, but modern model use more complex way to tokenize text.

  * vocabulary is a map that can encode token to number can decode number back to token

* then we encode the whole raw text into a sequence of number

* next, we need to convert the whole sequence of number into our training/testing features and label.

* we choose a time step n, we randomly choose n length of sequence of number as features and the label is the token that exact <font color="orange">one token shift</font> of the feature token. For example, if the text is "hello, world", and the time step we choose is 4, then a training data can be ['h', 'e', 'l', 'l'], then corresponding label data is ['e', 'l', 'l', 'o'], which means if the network sees 'h', it need to output 'e', if it sees 'e', then it should output 'l', etc.

## rnn

RNN is a network with hidden state

$$
\begin{align*}
H_t & = \phi(X_t W_{xh} + H_{t-1} W_{hh} + b_{h}) \\
O & = H_{t} W_{ho} + b_{o}
\end{align*}
$$

$t$ range in $[1, \text{Number of Time Steps}]$, Nomally, we will initialize the initial hidden state $H_{0}$ with zeros.

![](./d2l-summary/rnn.png)

During training steps, the feature data $X$ from dataset usually in the shape of $(batch\_size, time\_steps, vocab\_size)$ , normally will put the time_steps dimension to first, i.e. $(time\_steps, batch\_size, vocab\_size)$. After that, in every time step, we can calculate hidden states and output by batch. <font color="orange">And for every number time_steps of data in a batch, they corresponding to their own sequence of hidden states.</font>

<h2 id="Perplexity"><a href="#Perplexity" class="headerlink" title="Perplexity"></a>Perplexity</h2><p>Basically, perlexity is the exponential value of cross entropy loss. We can use perlexity to evaluate the performance of a lanuage model. <font color="orange">During training step we still the result of cross entropy loss to calculate the gradients and update parameters</font>. The cross entropy loss ranges in $[0, +\infty]$, so the perplexity ranges in $[1, +\infty]$.</p>
<h1 id="Modern-RNN"><a href="#Modern-RNN" class="headerlink" title="Modern RNN"></a>Modern RNN</h1><h2 id="LSTM-amp-GRU"><a href="#LSTM-amp-GRU" class="headerlink" title="LSTM &amp; GRU"></a>LSTM &amp; GRU</h2><p>LSTM and GRU are RNN models with more complex hidden states, they mainly design to prevent gradient exploding in training rnn.</p>
<h2 id="Deep-RNN"><a href="#Deep-RNN" class="headerlink" title="Deep RNN"></a>Deep RNN</h2><p>deep rnn increase the number of layers of hidden states.</p>
<p><img src="/2024/11/04/machine_learning/d2l-summary/deep-rnn.png" alt></p>
<p>As depicted in the graph, Hidden state is computed by:</p>
<script type="math/tex; mode=display">
H_{t}^{(l)} = \phi_{l}(H_{t}^{(l-1)} W_{xh}^{(l)} + H_{t-1}^{(l)} W_{hh}^{l} + b_{h}^{(l)})</script><p>To use deep rnn in pytorch, we only need to simply use the <code>num_layers</code> parameter</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nn.RNN(input_size=vocab_size, hidden_size=<span class="number">32</span>, num_layers=<span class="number">4</span>)</span><br><span class="line">nn.GRU(input_size=vocab_size, hidden_size=<span class="number">32</span>, num_layers=<span class="number">4</span>)</span><br><span class="line">nn.LSTM(input_size=vocab_size, hidden_size=<span class="number">32</span>, num_layers=<span class="number">4</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Bidirectional-RNN"><a href="#Bidirectional-RNN" class="headerlink" title="Bidirectional RNN"></a>Bidirectional RNN</h2><p>In Bidirectional RNN, in each hidden layer, there is a hidden state calculated from $t_1$ to $t_n$ and a hidden state calculated from $t_n$ to $t_1$, after that, we concat the hidden state in horizontal direction. As a result, the final output size of hidden state is the double of each hidden state size.</p>
<p><img src="/2024/11/04/machine_learning/d2l-summary/bidirectional-rnn.png" alt></p>
<p>A trick to calculate hidden state from $t_n$ to $t_1$ is to reverse input $X$ to $X_t$ to $X_1$ and then do calculated like normal input, this can speed up calculate instead of use for loop from $t$ to $1$.</p>
<p>Bidirectional RNNs are mostly useful for sequence encoding and the estimation of observations given bidirectional context.</p>
<p>Bidirectional RNNs are very costly to train due to long gradient chains.</p>
<p><font color="orange">Bidirectional RNNs are not quite useful in predicting next token by given tokens, as there are only information from past was given during prediction</font>.</p>
<h2 id="Encoder-Decoder-Framework"><a href="#Encoder-Decoder-Framework" class="headerlink" title="Encoder-Decoder Framework"></a>Encoder-Decoder Framework</h2><h2 id="Encoder-Decoder-for-Machine-Translation"><a href="#Encoder-Decoder-for-Machine-Translation" class="headerlink" title="Encoder-Decoder for Machine Translation"></a>Encoder-Decoder for Machine Translation</h2><h2 id="Beam-Search"><a href="#Beam-Search" class="headerlink" title="Beam Search"></a>Beam Search</h2><h1 id="Attention-Mechanisms-and-Transformers"><a href="#Attention-Mechanisms-and-Transformers" class="headerlink" title="Attention Mechanisms and Transformers"></a>Attention Mechanisms and Transformers</h1><h2 id="Queries-Keys-and-Values"><a href="#Queries-Keys-and-Values" class="headerlink" title="Queries, Keys, and Values"></a>Queries, Keys, and Values</h2><h1 id="Reinforcement-Learning"><a href="#Reinforcement-Learning" class="headerlink" title="Reinforcement Learning"></a>Reinforcement Learning</h1><h1 id="GAN"><a href="#GAN" class="headerlink" title="GAN"></a>GAN</h1><h1 id="Engineering"><a href="#Engineering" class="headerlink" title="Engineering"></a>Engineering</h1><h2 id="Parameter-Initialization-and-Management"><a href="#Parameter-Initialization-and-Management" class="headerlink" title="Parameter Initialization and Management"></a>Parameter Initialization and Management</h2><h2 id="Lazy-Initialization"><a href="#Lazy-Initialization" class="headerlink" title="Lazy Initialization"></a>Lazy Initialization</h2><h2 id="Compute-Devices"><a href="#Compute-Devices" class="headerlink" title="Compute Devices"></a>Compute Devices</h2><h2 id="Model-Backend"><a href="#Model-Backend" class="headerlink" title="Model Backend"></a>Model Backend</h2><h2 id="Data-Parallization-in-Multiple-GPUs"><a href="#Data-Parallization-in-Multiple-GPUs" class="headerlink" title="Data Parallization in Multiple GPUs."></a>Data Parallization in Multiple GPUs.</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://swordandtea.github.io/2024/10/08/machine_learning/reinforcement-learning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="SwordAndTea">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiangwei's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/08/machine_learning/reinforcement-learning/" class="post-title-link" itemprop="url">reinforcement-learning</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-10-08 14:33:02" itemprop="dateCreated datePublished" datetime="2024-10-08T14:33:02-04:00">2024-10-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-15 16:39:45" itemprop="dateModified" datetime="2024-10-15T16:39:45-04:00">2024-10-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/machine-learning/" itemprop="url" rel="index">
                    <span itemprop="name">machine learning</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>3.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Markov-Models"><a href="#Markov-Models" class="headerlink" title="Markov Models"></a>Markov Models</h1><p>Markov assumption states that the probability of the current state depends only on <font color="orange">a finite series</font> of previous states. As a special case, this assumption gives rise to the Markov chain representation, asserting that future state predictions are conditionally independent of the past given the present state-$P(X<em>t | X</em>{t-1})$</p>
<h1 id="Hidden-Markov-Models"><a href="#Hidden-Markov-Models" class="headerlink" title="Hidden Markov Models"></a>Hidden Markov Models</h1><p>In hidden markov models, our agent usually don’t have a information about the state, , instead, our agents gather observations over time.</p>
<p><img src="/2024/10/08/machine_learning/reinforcement-learning/hmm.png" alt="hmm"></p>
<p>A Hidden Markov Model consists of three fundamental components: the initial distribution $P(X1)$, transition probabilities denoted by $P(X<em>t | X</em>{t-1})$, and observation probabilities $P(O_t | X_t)$. Additionally, HMMs operate under two critical Markov assumptions:</p>
<ol>
<li><p>The future states of the system depend solely on the present state, encapsulated by the transition probabilities $P(X<em>t | X</em>{t-1})$.</p>
</li>
<li><p>The observation at a particular time step depend solely on the current state, encapsulated by the transition probabilities $P(O_t | X_t)$.</p>
</li>
</ol>
<h2 id="Compute-the-probability-of-an-observation-sequence"><a href="#Compute-the-probability-of-an-observation-sequence" class="headerlink" title="Compute the probability of an observation sequence"></a>Compute the probability of an observation sequence</h2><p>If we know the hidden state sequence, then the computation of the probability is straightforward.</p>
<script type="math/tex; mode=display">
P(O | S) = P((o_1, o_2, \dots, o_T) | S) = \prod_{t=1}^{T}P(s_t|s_{t-1}) \cdot P(o_t | s_t)</script><p>To compute $P(s_1 | s_0)$ in the above equation (the probability of being in a specific hidden state at the first time step), <font color="orange">we often simply resort to using the stationary distribution of the Markov chain defined over the hidden states</font>.</p>
<p>If we do not know the hidden state sequence, only know the observation sequence, then, in this scenario, we need to account for all possible hidden-state sequences, and sum over their joint probabilities with the observation sequence.</p>
<script type="math/tex; mode=display">
P(O) = \sum_{S} P(O | S) P(S)</script><p>However, if we do bruteforcely, for an HMM with $N$ hidden states and an observation sequence of $T$ observations, there are $N^T$ possible hidden sequences, which is unacceptable. <font color="orange">To solve this problem, we can exploit the fact that the probability of the observation sequence up to time $t$ can be computed using the probability of the observation sequence up to time $t-1</font>$. This is done by summing over the probabilities of all possible hidden-state sequences at time:</p>
<script type="math/tex; mode=display">
P(O_{0 \to t} | (s_t= s_i)) = \sum_{j=1}^{N} P(O_{0 \to t-1} | (s_{t-1}=s_j))P(s_i|s_j)P(o_t|s_i)</script><p>Then, we have</p>
<script type="math/tex; mode=display">
P(O_{o \to t}) = \sum_{i=1}^{N} P(O_{0 \to t} | (s_t= s_i))</script><p>Having the recurrance, we can use dynamic programming to solve this problem with a $O(N^2 T)$ time complexity. <font color="orange">Still, at $t=1$, we use stationary distribution to compute $P(O_{0 \to 1} | (s_1 = s_i) = P(s_i)P(o_1 |s_i)$</font>.</p>
<h2 id="Compute-the-most-likely-state-sequence-base-on-observation-sequence"><a href="#Compute-the-most-likely-state-sequence-base-on-observation-sequence" class="headerlink" title="Compute the most likely state sequence base on observation sequence"></a>Compute the most likely state sequence base on observation sequence</h2><p>We use Viterbi algorithm to solve this. Very much like the dp program in previous part:</p>
<script type="math/tex; mode=display">
P(O_{0 \to t} | (s_t= s_i)) = \max_{j=1}^{N} P(O_{0 \to t-1} | (s_{t-1}=s_j))P(s_i|s_j)P(o_t|s_i)</script><p>The final probability of the most likely hidden state sequence $S$ after $T$ time-steps is then given by</p>
<script type="math/tex; mode=display">
P(S) = \max_{i=1}^{N} P(O_{0 \to t} | (s_t= s_i))</script><p>Then</p>
<script type="math/tex; mode=display">
S = \argmax P(S)</script><h1 id="Markov-Decision-Process-MDP"><a href="#Markov-Decision-Process-MDP" class="headerlink" title="Markov Decision Process(MDP)"></a>Markov Decision Process(MDP)</h1><p>When an action taken from a state is no longer guaranteed to lead to a specific successor state. Instead, we now consider the scenario where there is a probability associated with each action leading our agent from one state to another.</p>
<p>For example from state $S_1$, the agent takes action $a$ , but may end up in state $S_2$ with probability of $p$ and $S_3$ with probability of $1-p$ . This stochastic system can be formally represented as a markov decision process(MDP).</p>
<p>For MDP, we have those info:</p>
<ul>
<li><p>State Space $S$ : the set of all possible states that the system can be in.</p>
</li>
<li><p>Action Space $A$ : the set of all possible actions, <font color="orange">if there is no actions can be taken from states, those states are therefore terminal or end states in the MDP.</font></p>
</li>
<li><p>Transition Probabilities $T$ : a the probabilities of transitioning from one state to another given a specific action, notated as $T(s, a, s’)$, where $s$ is the source state, $a$ is the action and $s’$ is the target/successor state.</p>
</li>
<li><p>Rewards $R$ : a numerical reward associated with each transition. In general, $R(s, a, s’)$ should be thought of as the reward of reaching state $s’$ from state $s$ using action $a$. </p>
</li>
<li><p>Discount Factor $\gamma$ : accounts for the discounting of future rewards in decision-making. It ensures that immediate rewards are valued more than future rewards. Discounting rewards in general prevents the agent from choosing actions that may lead to infinite rewards (cyclical paths).</p>
</li>
<li><p>Policy $\pi$ : a policy is defined as a mapping from states to actions. In other words, a policy defines a choice of <font color="orange">one action</font> for every state in MDP. <font color="orange">Note that a policy does not concern itself with the transition probabilities or rewards, but only with the actions to be taken in each state. It also says nothing about a specific path the agent might end up taking as a result of the chosen actions</font>. Different policies, therefore, may lead to different cumulative rewards <font color="orange">on average</font>. <font color="orange">The goal of the agent in an MDP is to find the policy that maximizes the expected cumulative reward over time</font>. This is known as the <em>optimal policy</em>. Here is a policy example: ${s_0: a_0, s_1: a_1, \dots, s_n:a_n}$, this policy says that: in state $s_0$, always take action $a_0$, in state $s_1$, always take action $a_1$,  and so on.</p>
</li>
</ul>
<h2 id="Evaluation-policies"><a href="#Evaluation-policies" class="headerlink" title="Evaluation policies"></a>Evaluation policies</h2><p>In order to find the best policy for our agent, we must be able to compare two or more given policies quantitatively. Under any one policy, even every time the agent is in a state, it takes the same action, the agent may end up in a different state each time (based on the values in Transition Probabilities $T$), so the outcome of the policy may vary, This is why <font color="orange">we need to evaluate policies in terms of their expected cumulative rewards rather than what happens in any one specific sample</font>.</p>
<p>A single actual path taken by the agent as a result of following a policy is called an <strong>episode</strong>. We define the <strong>Reward</strong> of an episode as the discounted sum of rewards along the path. Given the episode $E = (s_0, a_0, r_0, s_1, a_1, r_1, \dots, s_n, a_n, r_n)$, the Reward of the episode is given by:</p>
<script type="math/tex; mode=display">
R(E) = \sum_{t=0}^{n} \gamma^{t} r_t</script><p>where $r_t$ is the reward at time , and $\gamma$ is the discount factor. The expected Reward of a policy $\pi$ is then given by the expected value of the Reward of the episodes generated by the policy. Given a series of episodes, the expected value is simply the average of the utilities obtained in each episode; i.e., given a set of episodes $E_1, E_2, \dots, E_n$, the expected utility of the policy is given by:</p>
<script type="math/tex; mode=display">
E(R(\pi)) = \frac{1}{n} \sum_{i=1}^{n} R(E_i)</script><font color="orange">In practice, we are often concerned about the expected value of starting in a given state $s$ and following a policy $\pi$ from there</font>. This is called the **value** of the state under the policy, and denoted $V(s)$. 

Here, it is useful to define a second, related quantity, called the **Q-value**, defined over a state-action pair. The Q-value of a state-action pair $(s, a)$ under a policy $\pi$, denoted $Q(s, a)$, is the expected utility of starting in state $s$, taking action $a$, and then following policy $\pi$ <font color="orange">thereafter</font>.

Note that when the action $a$ is also the action dictated by the policy $\pi$, then we have $V_{\pi}(s) = Q_{\pi}(s, a=\pi(s))$ . 

<font color="orange">Finally, also note that the value of any end state is always $0$, since no action can be taken from that state.</font>

<p>By the definition above, we can deduce to the Bellman equation:</p>
<script type="math/tex; mode=display">
Q_{\pi}(s, a) = \sum_{s'} T(s, a, s')[R(s, a, s')] + \gamma V_{\pi}(s')</script><p>When $a=\pi(s)$, then $Q<em>{\pi}(s, a)=V</em>{\pi}(s)$, and the value of the state under the policy $\pi$ is then given by:</p>
<script type="math/tex; mode=display">
V_{\pi}(s) = \sum_{s'} T(s, a, s')[R(s, a, s')] + \gamma V_{\pi}(s')</script><p>While in certain situations, the above equations may yield a closed-form solution for the value of a state under a policy, in general, we need to solve a system of linear equations to find the value of each state under the policy. This is done using a dynamic programming algorithm that iteratively computes the value of each state under the policy <font color="orange">until the values converge</font>. This algorithm is called the <strong>Policy Evaluation</strong> algorithm, and works as follows. We re-write the above equation to use previous estimates of $V<em>{\pi}(s)$ to compute new estimates of $V</em>{\pi}(s)$ as follows:</p>
<script type="math/tex; mode=display">
V_{\pi}^{(t)}(s) = \sum_{s'} T(s, a, s')[R(s, a, s')] + \gamma V_{\pi}^{(t-1)}(s')</script><p>where $V_{\pi}^{(t)}$ is the estimate of the value of state $s$ under policy $\pi$ at iteration $t$. We start with an initial guess for the value of each state (usually set to 0), and then iteratively update the value of each state using the above equation until the values converge.</p>
<h2 id="Find-the-Best-Policy"><a href="#Find-the-Best-Policy" class="headerlink" title="Find the Best Policy"></a>Find the Best Policy</h2><p>Now that we have a way to evaluate the value of each state under a policy, we can use this information to find the best policy. The best policy is the one that maximizes the value of each state.</p>
<p>Given the value of each state $V<em>{\pi}(s)$ under some policy $\pi$, we can find the best action for each state by simply taking the action maximizes the expected value, i.e. $\argmax</em>{a} Q_{\pi}(s, a)$. This is known as the <em>greedy</em> policy.</p>
<p><font color="orange">We can use the policy evaluation algorithm to evaluate one policy, and then find the best action for each state to form a new policy. We can then evaluate this new policy and form next new policy, and so on, until the policy converges</font>. This is known as the <em>policy iteration</em> algorithm. The step of policy iteration algorithm:</p>
<ul>
<li><p>Initialize an guess for the value of each state $V(s)$ (usually set to 0)</p>
</li>
<li><p>Then we caculate Q-value of each possible action under a state $Q(s, a)$</p>
</li>
<li><p>After that, we can decide each state the currrent optimal action and form a new policy $\pi_{opt}$</p>
</li>
<li><p>Assign the maximum $Q(s, a)$ to the new $V(s)$</p>
</li>
<li><p>Then redo the process until the policy converges.</p>
</li>
</ul>
<p>there is one key difference  between policy evaluation alogrithm and policy iteration alogrithm: <font color="orange">instead of using a fixed policy $\pi$, we use the greedy policy at each iteration such that the chosen action maximizes the expected value</font>.</p>
<h1 id="Partially-Observable-MDPS"><a href="#Partially-Observable-MDPS" class="headerlink" title="Partially Observable MDPS"></a>Partially Observable MDPS</h1><p>In the previous discussion about MDP, agent knows precisely which state in the state-space it is currently in. However, in many real-life implementations of autonomous agents, the agent does not have a global view of the world, but must instead rely on observations of its immediate surroundings. Using these observations, the agent may then compute how likely it is to be in every possible state in the state space. Such scenarios can be modeled using the Partially Observable MDP (or POMDP) framework.</p>
<p>A POMDP need 2 more elements than MDP:</p>
<ul>
<li><p>Observation Space $O$: the set of all possible observations that the agent can make.</p>
</li>
<li><p>Observation Probabilities $\Omega$ : a function that gives the probability of making an observation given a specific state</p>
</li>
</ul>
<p><font color="orange">As in the MDP, the agent’s goal in a POMDP is to find the policy that maximizes the expected cumulative reward over time</font>.</p>
<p>Now, given an observation, the agent must update its belief about which state it is actually in, since the agent does not know this for sure. <font color="orange">The <strong>belief state</strong> is defined as a probability distribution over the state space</font>, representing the agent’s likelihood of being in each state in the state-space.</p>
<p>Instead of moving from state $s$ to $s’$ in MDP, in a POMDP, the agent transitions between belief states, say $b$ to $b’$ as the result of an action .</p>
<p>Given an observation, we need to calcuate the probability of being one state, i.e. $P(s|o)$. Luckily, Bayes’ theorem allows us to invert this dependency, and compute the probability as follows:</p>
<script type="math/tex; mode=display">
P(s|o) = \frac{P(o|s) \cdot P(s)}{P(o)}</script><p>where $P(o|s)$ is the probability of making the observation $o$ given the state $s$ - this is nothing but $\Omega(o, s)$, $P(s)$ is the prior probability of being in state $s$, and $P(o)$ is the probability of making the observation $o$ from any state, and is given by:</p>
<script type="math/tex; mode=display">
P(o) = \sum_{s \in S} P(o|s) \cdot P(s)</script><p><font color="orange">In practice, we can usually ignore the denominator, since it is the same for all states in the equation for</font> $P(s|o)$. Therefore, we can compute the belief state as</p>
<script type="math/tex; mode=display">
b(s) = P(o|s) \cdot P(s) = \Omega(o, s) \cdot P(s)</script><p>where $b(s)$ is the probability of being in state $s$ given the observation $o$, i.e. $P(s|o)$.</p>
<p>We can now begin to reason about the transition <em>between belief states</em> for POMDPs, instead of the transition model between states in standard MDPs. First, let us compute the belief state update resulting from this specific action and observation, and we will then discuss the belief state transition in general. The belief state update is given by:</p>
<script type="math/tex; mode=display">
b^{(t)}(s') = \sum_{s \in S} T(s, a, s') \Omega(o, s')b^{(t-1)}(s)</script><p>where $b^{(t)}(s’)$ is the probability of being in state $s’$ after taking action $a$ and making observation $o$, and $b^{(t-1)}(s)$ is the last-known probability of being in state $s$ before taking action. There are a few key things to keep in mind here:</p>
<ul>
<li><p>First, note that we update the probability of being in every <em>target</em> cell $s’$, summing over all origin state $s$ from where the action $a$ could have brought us to $s’$. This is opposite to the MDP Bellman equation, where we update the value of every <em>origin</em> state $s$, summing over all target states $s’$ under the action $a$.</p>
</li>
<li><p>Second, just like the Bellman updates, the above belief-state update is calculated for every state in the state-space, considering each as a target state under the action $a$.</p>
</li>
<li><p>Third, result ofactions may be stochastic, therefore we still have a notion of an action taking the agent to a different state.</p>
</li>
</ul>
<p><font color="orange">Now we give previous belief state, an action and an observation after that action, we can compute the new belief state</font>. Next, we need to estimate $T(b, a, b’)$, the probability of transitioning to one specific belief state from a previous one, given an action, accounting for all possible observations as a result of that action. We must keep in mind that unlike the number of states in an MDP, <font color="orange">the number of belief states in a POMDP is infinite</font>, since every probability distribution over the state-space is a valid belief state. However, given any one belief state, if we take an action and make an observation, we can only end up in one new belief state.</p>
<h1 id="Reinforcement-Learning"><a href="#Reinforcement-Learning" class="headerlink" title="Reinforcement Learning"></a>Reinforcement Learning</h1><p>As our final layer of complexity, imagine a situation where neither the transition probabilities nor the rewards are known a priori. <font color="orange">The action space is assumed to be fully known</font>, and the state space may or may not be fully known. In such environments, we deploy a class of algorithms known collectively as reinforcement learning (RL), where the agent learns to make decisions through interactions with the environment. The agent may choose to infer or estimate the underlying mechanics of the world such as $T(s, a, s’)$ and $R(s, a, s’)$, or directly try to optimize the value function in search of an optimal policy.</p>
<h2 id="Model-Based-Monte-Carlo-MBMC"><a href="#Model-Based-Monte-Carlo-MBMC" class="headerlink" title="Model Based Monte Carlo (MBMC)"></a>Model Based Monte Carlo (MBMC)</h2><p>we assume an underlying MDP, and use the episodes data solely to infer the model’s parameters(transition probabilities and rewards). Once we have an MDP, evaluating a given policy, or computing the optimal policy proceeds exactly as we did before. However, this approach may have a few drawbacks:</p>
<ul>
<li><p>MBMC approaches use data-based estimates to construct a fixed model of the environmentOnce this model is constructed, it is typically not updated</p>
</li>
<li><p>The second drawback is that policy evaluation and optimal policy estimation for a given MDP is computationally expensive. To compute optimal policies, we must consider all possible actions from all states, running a large number of updates for each legal state-action pair until the values converge.</p>
</li>
</ul>
<h2 id="Model-Free-Monte-Carlo-MFMC"><a href="#Model-Free-Monte-Carlo-MFMC" class="headerlink" title="Model Free Monte Carlo (MFMC)"></a>Model Free Monte Carlo (MFMC)</h2><p>we use the data from the environment to directly estimate Q-values, without first constructing the underlying MDP.</p>
<h2 id="Q-Learning"><a href="#Q-Learning" class="headerlink" title="Q-Learning"></a>Q-Learning</h2><p>Q-Learning is an <strong>off-policy value-based method that uses a TD approach to train its action-value function</strong></p>
<ul>
<li><p>First we initialize for All State-Action Value (or State Value) with 0</p>
</li>
<li><p>We use Epsilon($\epsilon$)-Greedy Policy to choose our action</p>
<ul>
<li><p>each step with $\epsilon$ probability to choose random action</p>
</li>
<li><p>with $1 - \epsilon$ probabilty to choose the optimal action</p>
</li>
<li><p>initially, $\epsilon$ is 1, and after some time steps, it will drop to some smaller value</p>
</li>
</ul>
</li>
<li><p>Then, we update our State-Action Value table (or State Value table) for each $(S, A, R,S’)$ pairs</p>
<script type="math/tex; mode=display">
\begin{gather*}
Q_{new}(S, A) \gets V_{old}(S, A) + lr \times [R + \gamma \times max(Q_{old}(S', A)) - Q_{old}(S, A)] \\
\text{or} \\
V_{new}(S) \gets V_{old(S)} + lr \times [R + \gamma \times V_{old}(S') - V_{old}(S)]
\end{gather*}</script></li>
</ul>
<p>Explain for the word <font color="orange">Off-policy: using a different policy for acting and updating</font>. For instance, <font color="orange">with Q-Learning, the epsilon-greedy policy (acting policy), is different from the greedy policy that is <strong>used to select the best next-state action value to update our Q-value (updating policy)</strong></font>.</p>
<p>While <font color="orange">On-policy: using the same policy for acting and updating</font>. For instance, with Sarsa, another value-based algorithm, the epsilon-greedy policy selects the next state-action pair, not a greedy policy.</p>
<h1 id="Deep-Q-Learning"><a href="#Deep-Q-Learning" class="headerlink" title="Deep Q-Learning"></a>Deep Q-Learning</h1><p>Q-Learning worked well with small state space environments, if the states and actions spaces are not small enough to be represented efficiently by arrays and tables, Q-Learning Cannot solve those problem efficiently.</p>
<p>Instead of using a Q-table, Deep Q-Learning uses a Neural Network that takes a state as input and approximates Q-values for <font color="orange">each action</font> based on that state.</p>
<p>in Deep Q-Learning, we create a loss function that compares our Q-value prediction and the Q-target and uses gradient descent to update the weights of our Deep Q-Network to approximate our Q-values better.</p>
<p>The Deep Q-Learning training algorithm has two phases:</p>
<ul>
<li>Sampling: we perform actions and store the observed experience tuples in a replay memory.</li>
<li>Training: Select a small batch of tuples randomly and learn from this batch using a gradient descent update step.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://swordandtea.github.io/2024/04/26/machine_learning/batch-normalization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="SwordAndTea">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiangwei's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/26/machine_learning/batch-normalization/" class="post-title-link" itemprop="url">batch-normalization</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-04-26 09:54:27" itemprop="dateCreated datePublished" datetime="2024-04-26T09:54:27-04:00">2024-04-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-30 10:39:13" itemprop="dateModified" datetime="2024-09-30T10:39:13-04:00">2024-09-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/machine-learning/" itemprop="url" rel="index">
                    <span itemprop="name">machine learning</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>644</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="What"><a href="#What" class="headerlink" title="What"></a>What</h1><p>Batch normalization is applied to individual layers, or optionally, to all of them: In each training iteration, we first normalize the inputs (of batch normalization) by subtracting their mean and dividing by their standard deviation, where both are estimated based on the statistics of the current minibatch.</p>
<p>Next, we apply a scale coefficient and an offset to recover the lost degrees of freedom.</p>
<font color="orange">Note that if we tried to apply batch normalization with minibatches of size 1, we would not be able to learn anything. That is because after subtracting the means, each hidden unit would take value 0. when applying batch normalization, the choice of batch size is even more significant than without batch normalization</font>, batch normalization works best for moderate minibatch sizes in the 50–100 range.

Denote by $B$ a minibatch and let $x \in B$ be an input to batch normalization ($BN$). In this case the batch normalization is defined as follows:

$$
BN(x) = \gamma \times \frac{x-\mu_{B}}{\sigma_{B}} + \beta
$$

 $\mu_{B}$is the sample mean and $\sigma_{B}$ is the sample standard deviation of the minibatch . *scale parameter* $\gamma$ and *shift parameter* $\beta$ <font color="orange">have the same shape as $x$ </font>and are parameters that <font color="orange">need to be learned</font> as part of model training.

batch normalization layers function differently in *training mode*than in *prediction mode*. 

# Batch Normalization Layers

Batch normalization implementations for fully connected layers and convolutional layers are slightly different.

## Fully Connected Layers

Denoting the input to the fully connected layer by $x$, the affine transformation by  (with the weight parameter $W$ and the bias parameter $b$), and the activation function by $\phi$, we can express the computation of a batch-normalization-enabled, fully connected layer output $h$ as follows:

$$
h = \phi(BN(Wx+b))
$$

batch normalization <font color="orange">usually</font> is applied before activation function, but it can also applied  after activation function. <font color="orange">Moreover, there is no need to batch normalization and dropout simultaneously</font>

<h2 id="Convolutional-Layers"><a href="#Convolutional-Layers" class="headerlink" title="Convolutional Layers"></a>Convolutional Layers</h2><p>Similarly, with convolutional layers, we can apply batch normalization after the convolution but before the nonlinear activation function. The key difference from batch normalization in fully connected layers is that we apply the operation on a per-channel basis <em>across all locations</em>. <font color="orange">In other word, batch normalization is applied in the demension of channels, channels is kinda like the features that in the full connected layer</font>.</p>
<p>Assume that our minibatches contain $m$ examples and that for each channel, the output of the convolution has height $p$ and width $q$. For convolutional layers, we carry out each batch normalization over the $m \cdot p \cdot q$ elements per output channel simultaneously. Each channel has its own scale $\gamma$ and shift $\beta$ parameters.</p>
<h2 id="Layer-Normalization"><a href="#Layer-Normalization" class="headerlink" title="Layer Normalization"></a>Layer Normalization</h2><p>Note that in the context of convolutions the batch normalization is well defined even for minibatches of size 1: after all, we have all the locations across an image to average. Consequently, mean and variance are well defined, even if it is just within a single observation. This consideration led to introduce the notion of <em>layer normalization</em>. It works just like a batch norm, only that it is applied to one observation at a time.</p>
<p>For an n-dimensional vector $x$, layer norms are given by</p>
<script type="math/tex; mode=display">
LN(x) = \frac{x-\mu}{\sigma}</script><p>layer normalization does not depend on the minibatch size. <font color="orange">It is also independent of whether we are in training or test regime.</font></p>
<h1 id="Conclusion-difference-between-batch-normalization-and-layer-normalization"><a href="#Conclusion-difference-between-batch-normalization-and-layer-normalization" class="headerlink" title="Conclusion: difference between batch normalization and layer normalization"></a>Conclusion: difference between batch normalization and layer normalization</h1><font color="orange">batch normalization is applied on same feature with different samples, while layer normalization is applied on differenct featurens with only one sample.</font>

<h1 id="What-Can-Batch-normalization-achieve"><a href="#What-Can-Batch-normalization-achieve" class="headerlink" title="What Can Batch normalization achieve"></a>What Can Batch normalization achieve</h1><p>Bacth normalization can speed up convergence, so that we can change learning rate to a bigger value</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://swordandtea.github.io/2024/04/15/machine_learning/weight-decay/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="SwordAndTea">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiangwei's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/15/machine_learning/weight-decay/" class="post-title-link" itemprop="url">weight-decay</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-04-15 10:49:34" itemprop="dateCreated datePublished" datetime="2024-04-15T10:49:34-04:00">2024-04-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-28 15:38:22" itemprop="dateModified" datetime="2024-09-28T15:38:22-04:00">2024-09-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/machine-learning/" itemprop="url" rel="index">
                    <span itemprop="name">machine learning</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>329</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Norms-and-Weight-Decay"><a href="#Norms-and-Weight-Decay" class="headerlink" title="Norms and Weight Decay"></a>Norms and Weight Decay</h1><p>We can always mitigate overfitting by collecting more training data. However, that can be costly, time consuming, or entirely out of our control, making it impossible in the short run.</p>
<p>Rather than directly manipulating the number of parameters, <em>weight decay</em>, operates by restricting the values that the parameters can take.  weight decay might be the most widely used technique for regularizing parametric machine learning models.</p>
<script type="math/tex; mode=display">
Loss = \frac{1}{n}\sum_{i=1}^{n} \frac{1}{2} (w^T x^{(i) + b} - y^{(i)})^2 + \frac{\lambda}{2}||w||^2</script><p>and the updation for w in stochastic gradient descent with this loss function will be:</p>
<script type="math/tex; mode=display">
w \leftarrow (1 - lr \times \lambda) w - \frac{lr}{n} \sum_{i=1}^{n} x^{(i)}(w^T x^{(i)} + b - y^{(i)})</script><p>every literation, we will shrink w by $lr \times \lambda$ first, that’s why this method is called weight decay.</p>
<font color="orange">Often, we do not regularize the bias term.</font>

<h1 id="为什么Weight-Decay可以一定程度上缓解过拟合"><a href="#为什么Weight-Decay可以一定程度上缓解过拟合" class="headerlink" title="为什么Weight Decay可以一定程度上缓解过拟合"></a>为什么Weight Decay可以一定程度上缓解过拟合</h1><p>因为在实际中，用于机器学习的数据是有噪声的，这些噪声会导致模型无法真正学习到最优的解，一般会和最优解有偏差，<font color="orange">而且，可以证明，当噪声越大，学习到的$w$就会越大</font>。这时可以通过weight decay调整$\lambda$的值来讲学习到的解拉近到真正最优解，如果$\lambda$过小，拉近之后的解仍然会离真正的最优解一定距离，如果$\lambda$过大，就会导致从另外一个方向远离真正最优解。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://swordandtea.github.io/2024/03/29/babylonJS/particles/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="SwordAndTea">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiangwei's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/29/babylonJS/particles/" class="post-title-link" itemprop="url">particles</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-03-29 09:35:59" itemprop="dateCreated datePublished" datetime="2024-03-29T09:35:59-04:00">2024-03-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-03-28 21:35:59" itemprop="dateModified" datetime="2024-03-28T21:35:59-04:00">2024-03-28</time>
              </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://swordandtea.github.io/2024/03/23/babylonJS/environment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="SwordAndTea">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiangwei's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/23/babylonJS/environment/" class="post-title-link" itemprop="url">environment</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-03-23 11:39:47" itemprop="dateCreated datePublished" datetime="2024-03-23T11:39:47-04:00">2024-03-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-03-25 22:44:52" itemprop="dateModified" datetime="2024-03-25T22:44:52-04:00">2024-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/BabylonJS/" itemprop="url" rel="index">
                    <span itemprop="name">BabylonJS</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>773</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction-To-Environment"><a href="#Introduction-To-Environment" class="headerlink" title="Introduction To Environment"></a>Introduction To Environment</h1><h2 id="clearColor"><a href="#clearColor" class="headerlink" title="clearColor"></a>clearColor</h2><p>The ‘clearColor’ property on the scene object is the most rudimentary of environment properties/adjustments. Simply stated, this is how you change the background color of the scene. Here is how it is done:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scene.clearColor = <span class="keyword">new</span> BABYLON.Color3(<span class="number">0.5</span>, <span class="number">0.8</span>, <span class="number">0.5</span>);</span><br></pre></td></tr></table></figure>
<p>This color and property is not used in any calculations for the final colors of mesh, materials, textures, or anything else. It is simply the background color of the scene. Easy.</p>
<h2 id="ambientColor"><a href="#ambientColor" class="headerlink" title="ambientColor"></a>ambientColor</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scene.ambientColor = <span class="keyword">new</span> BABYLON.Color3(<span class="number">0.3</span>, <span class="number">0.3</span>, <span class="number">0.3</span>);</span><br></pre></td></tr></table></figure>
<p>Mainly, it is used in conjunction with a mesh’s <code>StandardMaterial.ambientColor</code> to determine a FINAL <code>ambientColor</code> for the mesh material. </p>
<p>When there is no <code>scene.ambientColor</code>, then <code>StandardMaterial.ambientColor</code> and <code>StandardMaterial.ambientTexture</code> will appear to do nothing.</p>
<p>Set a <code>scene.ambientColor</code> of some value, <code>StandardMaterial.ambientColor</code>/<code>StandardMaterial.ambientTexture</code> will become active on meshes where you have applied such.</p>
<p>By default, <code>scene.ambientColor</code> is set to <code>Color3(0, 0, 0)</code>, which means there is no <code>scene.ambientColor</code>.</p>
<h1 id="Fog"><a href="#Fog" class="headerlink" title="Fog"></a>Fog</h1><p>Fog is quite an advanced effect, but fog in Babylon.js has been simplified to the maximum. It’s now very easy to add fog to your scenes.  First, we define the fog mode like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scene.fogMode = BABYLON.Scene.FOGMODE_EXP;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>BABYLON.Scene.FOGMODE_NONE</code> - default one, fog is deactivated.</li>
<li><code>BABYLON.Scene.FOGMODE_EXP</code> - the fog density is following an exponential function.</li>
<li><code>BABYLON.Scene.FOGMODE_EXP2</code> - same that above but faster.</li>
<li><code>BABYLON.Scene.FOGMODE_LINEAR</code> - the fog density is following a linear function.</li>
</ul>
<p>If you choose the <code>EXP</code>, or <code>EXP2</code> mode, then you can define the density option (default is <code>0.1</code>):</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scene.fogDensity = <span class="number">0.01</span>;</span><br></pre></td></tr></table></figure>
<p>if you choose <code>LINEAR</code> mode, then you can define where fog starts and where fog ends:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scene.fogStart = <span class="number">20.0</span>;</span><br><span class="line">scene.fogEnd = <span class="number">60.0</span>;</span><br></pre></td></tr></table></figure>
<p>Finally, whatever the mode, you can specify the color of the fog (default is <code>BABYLON.Color3(0.2, 0.2, 0.3)</code>):</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scene.fogColor = <span class="keyword">new</span> BABYLON.Color3(<span class="number">0.9</span>, <span class="number">0.9</span>, <span class="number">0.85</span>);</span><br></pre></td></tr></table></figure>
<h1 id="Skyboxes"><a href="#Skyboxes" class="headerlink" title="Skyboxes"></a>Skyboxes</h1><p>In Babylon.js, skyboxes typically use <a target="_blank" rel="noopener" href="https://doc.babylonjs.com/typedoc/classes/babylon.cubetexture">CubeTexture</a> on a large cube.</p>
<p>The CubeTexture constructor takes a base URL and (by default) appends “_px.jpg”, “_nx.jpg”, “_py.jpg”, “_ny.jpg”, “_pz.jpg” and “_nz.jpg” to load the +x, -x, +y, -y, +z, and -z facing sides of the cube. (These suffixes may be customized if needed.)</p>
<p>CubeTexture images need to be .jpg format (unless the suffixes are customized) and square. For efficiency, use a power of 2 size, like 1024x1024.</p>
<h2 id="Manual-creation"><a href="#Manual-creation" class="headerlink" title="Manual creation"></a>Manual creation</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> skybox = BABYLON.MeshBuilder.CreateBox(<span class="string">&quot;skyBox&quot;</span>, &#123; <span class="attr">size</span>: <span class="number">100.0</span> &#125;, scene);</span><br><span class="line"><span class="keyword">const</span> skyboxMaterial = <span class="keyword">new</span> BABYLON.StandardMaterial(<span class="string">&quot;skyBox&quot;</span>, scene);</span><br><span class="line">skyboxMaterial.backFaceCulling = <span class="literal">false</span>;</span><br><span class="line">skybox.material = skyboxMaterial;</span><br></pre></td></tr></table></figure>
<p>Next, we set the <code>infiniteDistance</code> property. This makes the skybox follow our camera’s position.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">skybox.infiniteDistance = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>Now we must remove all light reflections on our box (the sun doesn’t reflect on the sky!):</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">skyboxMaterial.disableLighting = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>Next, we apply our special sky texture to it. This texture must have been prepared to be a skybox, in a dedicated directory, named “skybox” in our example:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">skyboxMaterial.reflectionTexture = <span class="keyword">new</span> BABYLON.CubeTexture(<span class="string">&quot;textures/skybox&quot;</span>, scene);</span><br><span class="line">skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;</span><br></pre></td></tr></table></figure>
<p>In that <code>/skybox</code> directory, we must find 6 sky textures, one for each face of our box. Each image must be named per the corresponding face: “skybox_nx.jpg” (left), “skybox_ny.jpg” (down), “skybox_nz.jpg” (back), “skybox_px.jpg” (right), “skybox_py.jpg” (up), “skybox_pz.jpg” (front). The “_nx.jpg” is added to your path.</p>
<p>You can also use dds files to specify your skybox. These special files can contain all information required to setup a cube texture:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">skyboxMaterial.reflectionTexture = <span class="keyword">new</span> BABYLON.CubeTexture(<span class="string">&quot;/assets/textures/SpecularHDR.dds&quot;</span>, scene);</span><br></pre></td></tr></table></figure>
<p>Final note, if you want your skybox to render behind everything else, set the skybox’s <code>renderingGroupId</code> to <code>0</code>, and every other renderable object’s <code>renderingGroupId</code> greater than zero</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">skybox.renderingGroupId = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Some other mesh</span></span><br><span class="line">myMesh.renderingGroupId = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h2 id="Automatic-creation"><a href="#Automatic-creation" class="headerlink" title="Automatic creation"></a>Automatic creation</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">envTexture = <span class="keyword">new</span> BABYLON.CubeTexture(<span class="string">&quot;/assets/textures/SpecularHDR.dds&quot;</span>, scene);</span><br><span class="line">scene.createDefaultSkybox(envTexture, <span class="literal">true</span><span class="comment">/*use a PBRMaterial*/</span>, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>
<h1 id="Background-Materials"><a href="#Background-Materials" class="headerlink" title="Background Materials"></a>Background Materials</h1><p>The background material is fully unlit (which means it can still show color even there is no light created in the scene) but can still receive shadows or be subject to image processing information. This makes it the best fit to use as a skybox or the material of ground.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> backgroundMaterial = <span class="keyword">new</span> BABYLON.BackgroundMaterial(<span class="string">&quot;backgroundMaterial&quot;</span>, scene);</span><br></pre></td></tr></table></figure>
<h2 id="Diffuse"><a href="#Diffuse" class="headerlink" title="Diffuse"></a>Diffuse</h2><p>The diffuse part is used to simply give a color to the mesh.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">backgroundMaterial.diffuseTexture = <span class="keyword">new</span> BABYLON.Texture(<span class="string">&quot;textures/grass.jpg&quot;</span>, scene);</span><br></pre></td></tr></table></figure>
<h2 id="Shadows"><a href="#Shadows" class="headerlink" title="Shadows"></a>Shadows</h2><p>The material is able to receive shadows despite being unlit. This is actually one of its strength making it really attractive for grounds. If you want to dim the amount of shadows, you can use the dedicated properties:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">backgroundMaterial.shadowLevel = <span class="number">0.4</span>;</span><br></pre></td></tr></table></figure>
<p>Starting from Babylonjs v4.2, there’s also a new <code>shadowOnly</code> property that only renders shadow, making the material behave like the <code>ShadowOnlyMaterial</code> material but without the single light restriction.</p>
<p>When <code>shadowOnly = true</code>, you can use <code>primaryColor</code> to tint the shadow color and <code>alpha</code> to make the shadows more or less strong</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> backgroundMaterial = <span class="keyword">new</span> BABYLON.BackgroundMaterial(<span class="string">&quot;backgroundMaterial&quot;</span>, scene);</span><br><span class="line"></span><br><span class="line">backgroundMaterial.primaryColor = <span class="keyword">new</span> BABYLON.Color4(<span class="number">0.6</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">backgroundMaterial.shadowOnly = <span class="literal">true</span>;</span><br><span class="line">backgroundMaterial.alpha = <span class="number">0.4</span>;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://swordandtea.github.io/2024/03/21/babylonJS/material/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="SwordAndTea">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiangwei's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/21/babylonJS/material/" class="post-title-link" itemprop="url">material</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-03-21 11:44:20" itemprop="dateCreated datePublished" datetime="2024-03-21T11:44:20-04:00">2024-03-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-03-27 23:32:28" itemprop="dateModified" datetime="2024-03-27T23:32:28-04:00">2024-03-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/BabylonJS/" itemprop="url" rel="index">
                    <span itemprop="name">BabylonJS</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction-To-Material"><a href="#Introduction-To-Material" class="headerlink" title="Introduction To Material"></a>Introduction To Material</h1><p>Materials allow you to cover your meshes in color and texture. <font color="orange">How a material appears depends on the lights used in the scene and how it is set to react</font>.</p>
<p>There are four possible ways that a material can react to light.</p>
<ol>
<li>Diffuse - the basic color or texture of the material as viewed under a light;</li>
<li>Specular - the highlight given to the material by a light;</li>
<li>Emissive - the color or texture of the material as if self lit;</li>
<li>Ambient - the color or texture of the material lit by the environmental background lighting.</li>
</ol>
<p>Diffuse and Specular material require a light source to be created.<br>Ambient color requires the ambient color of the scene to be set, giving the environmental background lighting.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myMaterial = <span class="keyword">new</span> BABYLON.StandardMaterial(<span class="string">&quot;myMaterial&quot;</span>, scene);</span><br><span class="line"></span><br><span class="line">myMaterial.diffuseColor = <span class="keyword">new</span> BABYLON.Color3(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">myMaterial.specularColor = <span class="keyword">new</span> BABYLON.Color3(<span class="number">0.5</span>, <span class="number">0.6</span>, <span class="number">0.87</span>);</span><br><span class="line">myMaterial.emissiveColor = <span class="keyword">new</span> BABYLON.Color3(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">myMaterial.ambientColor = <span class="keyword">new</span> BABYLON.Color3(<span class="number">0.23</span>, <span class="number">0.98</span>, <span class="number">0.53</span>);</span><br><span class="line"></span><br><span class="line">mesh.material = myMaterial;</span><br></pre></td></tr></table></figure>
<h2 id="Transparent-Color"><a href="#Transparent-Color" class="headerlink" title="Transparent Color"></a>Transparent Color</h2><p>Transparency is achieved by setting a materials <em>alpha</em> property from 0 (invisible) to 1 (opaque).</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myMaterial.alpha = <span class="number">0.5</span>;</span><br></pre></td></tr></table></figure>
<p>In addition, the image used for the texture might already have a transparency setting,In this case we set the <em>hasAlpha</em> property of the <strong>texture</strong> to true.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myMaterial.diffuseTexture.hasAlpha = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h2 id="Back-Face-Culling"><a href="#Back-Face-Culling" class="headerlink" title="Back-Face Culling"></a>Back-Face Culling</h2><p>Usually there is no need to draw the back face of a cube, or other object, as it will be hidden by the front face. In Babylon.js the default setting is set to true. But, in some cases such as transparent front side, you need to see the back face, then you should set the material property <em>backFaceCulling</em> to false</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myMaterial.backFaceCulling = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<h2 id="WireFrame"><a href="#WireFrame" class="headerlink" title="WireFrame"></a>WireFrame</h2><p>You can see a mesh in wireframe mode by using:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">materialSphere1.wireframe = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h1 id="Bump-Map"><a href="#Bump-Map" class="headerlink" title="Bump Map"></a>Bump Map</h1><p>Bump mapping is a technique to simulate bump and dents on a rendered surface. These are made by creating a <strong>normal map</strong> from an image. The means to do this can be found on the web, a search for ‘normal map generator’ will bring up free and paid for methods of doing this.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myMaterial = <span class="keyword">new</span> BABYLON.StandardMaterial(<span class="string">&quot;myMaterial&quot;</span>, scene);</span><br><span class="line">myMaterial.bumpTexture = <span class="keyword">new</span> BABYLON.Texture(<span class="string">&quot;PATH TO NORMAL MAP&quot;</span>, scene);</span><br></pre></td></tr></table></figure>
<p>Use <em>invertNormalMapX</em> and/or <em>invertNormalMapY</em> on the material can invert Bumps and Dents</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myMaterial = <span class="keyword">new</span> BABYLON.StandardMaterial(<span class="string">&quot;myMaterial&quot;</span>, scene);</span><br><span class="line">myMaterial.bumpTexture = <span class="keyword">new</span> BABYLON.Texture(<span class="string">&quot;PATH TO NORMAL MAP&quot;</span>, scene);</span><br><span class="line">myMaterial.invertNormalMapX = <span class="literal">true</span>;</span><br><span class="line">myMaterial.invertNormalMapY = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h1 id="Opacity-Map"><a href="#Opacity-Map" class="headerlink" title="Opacity Map"></a>Opacity Map</h1><p>The opacity of a material can be graded using an image with varying tranparency</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myMaterial = <span class="keyword">new</span> BABYLON.StandardMaterial(<span class="string">&quot;myMaterial&quot;</span>, scene);</span><br><span class="line">myMaterial.opacityTexture = <span class="keyword">new</span> BABYLON.Texture(<span class="string">&quot;PATH TO OPACITY MAP&quot;</span>, scene);</span><br></pre></td></tr></table></figure>
<h1 id="Tiling-and-Offsetting"><a href="#Tiling-and-Offsetting" class="headerlink" title="Tiling and Offsetting"></a>Tiling and Offsetting</h1><p>When a material is applied to a mesh the image used for a texture is positioned according to coordinates. Rather than x, y which are already in use for the 3D axes the letters u and v are used for the coordinates.</p>
<p>To tile an image you use the <em>uScale</em> and/or <em>vScale</em> properties, of the texture, to set the number of tiles in each direction.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">myMaterial.diffuseTexture.uScale = <span class="number">5.0</span>;</span><br><span class="line">myMaterial.diffuseTexture.vScale = <span class="number">5.0</span>;</span><br></pre></td></tr></table></figure>
<p>To offset your texture on your mesh, you use the <em>uOffset</em> and <em>vOffset</em> properties, of the texture, to set the offset in each direction.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">myMaterial.diffuseTexture.uOffset = <span class="number">1.5</span>; <span class="comment">// 1.5 is actually equal to 0.5</span></span><br><span class="line">myMaterial.diffuseTexture.vOffset = <span class="number">0.5</span>;</span><br></pre></td></tr></table></figure>
<h1 id="Details-Map"><a href="#Details-Map" class="headerlink" title="Details Map"></a>Details Map</h1><p>A detail map (also called secondary map) is generally used to add extra details to the regular main texture when viewed up close.</p>
<p>The detail map can contains albedo (diffuse), normal and roughness (for PBR materials only) channels, dispatched this way (following <strong>Unity</strong> convention):</p>
<ul>
<li>Red channel: greyscale albedo</li>
<li>Green channel: green component of the normal map</li>
<li>Blue channel: roughness</li>
<li>Alpha channel: red component of the normal map</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">myMaterial.detailMap.texture = <span class="keyword">new</span> BABYLON.Texture(<span class="string">&quot;textures/detailmap.png&quot;</span>, scene);</span><br><span class="line">myMaterial.detailMap.isEnabled = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h1 id="Parallax-Mapping"><a href="#Parallax-Mapping" class="headerlink" title="Parallax Mapping"></a>Parallax Mapping</h1><p>Parallax Mapping is an algorithm which, based from a height map, apply an offset on the material’s textures in order to accentuate the effect of relief in the geometry’s surface.</p>
<p>While this technique is independent from Normal Mapping (a.k.a Bump) it’s often used in conjunction with it. The simple reason is that the height map needed to perform Parallax Mapping is most of the time encoded in the Alpha channel of the Normal Map texture. (A diffuse texture is required for using parallax mapping).</p>
<p>Babylon.js supports two kinds of Parallax Mapping Principle: Parallax Mapping and Parallax Occlusion</p>
<ul>
<li><p>Parallax Mapping:The core algorithm which perform an offset computation for the texture UV coordinates, based on a height map. This algorithm is really quick to perform, you can almost think of it as being free if you already are using Bump.</p>
</li>
<li><p>Parallax Occlusion Mapping (POM): While traditional Parallax mapping compute the offset based on one sample of the height map, the Occlusion version will make a loop to sample the height map many times in order to reach a more precise location of what the pixel to compute should reflect. <font color="orange">The outcome is way more realistic than traditional Parallax but there can be a performance hit that needs consideration.</font></p>
</li>
</ul>
<p>In Babylon.js we think of a parallax mapping as an extension of Normal Mapping, hence to benefit of the former, you have to enable the later. <font color="orange">The reason is that we support only the height map being encoded in the Alpha channel of the normal map</font>, as explained above.</p>
<p>You have three properties to work with Parallax:</p>
<ul>
<li><strong>useParallax</strong>: enables Parallax Mapping over Bump. This property won’t have any effect if you didn’t assigned a <strong>bumpTexture</strong>.</li>
<li><strong>useParallaxOcclusion</strong>: enables Parallax Occlusion, when setting this property, you must also set <strong>useParallax</strong> to true.</li>
<li><strong>parallaxScaleBias</strong>: apply a scaling factor that determine which “depth” the height map should represent. A value between 0.05 and 0.1 is reasonable in Parallax, you can reach 0.2 using Parallax Occlusion.</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">material.bumpTexture = someTextureFromNormalMap;</span><br><span class="line">material.useParallax = <span class="literal">true</span>;</span><br><span class="line">material.useParallaxOcclusion = <span class="literal">true</span>;</span><br><span class="line">material.parallaxScaleBias = <span class="number">0.075</span>;</span><br></pre></td></tr></table></figure>
<h1 id="Understanding-Normal-Maps"><a href="#Understanding-Normal-Maps" class="headerlink" title="Understanding Normal Maps"></a>Understanding Normal Maps</h1><p>Babylon.js was originally designed based on DirectX principles, it has since become more convention agnostic as there are plenty of tools available to make your assets work correctly so long as you know where you are coming from and where you are going.</p>
<h1 id="Blend-Mode"><a href="#Blend-Mode" class="headerlink" title="Blend Mode"></a>Blend Mode</h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://swordandtea.github.io/2024/03/14/babylonJS/scene/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="SwordAndTea">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiangwei's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/14/babylonJS/scene/" class="post-title-link" itemprop="url">scene</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-03-14 12:11:47" itemprop="dateCreated datePublished" datetime="2024-03-14T12:11:47-04:00">2024-03-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-03-26 22:12:12" itemprop="dateModified" datetime="2024-03-26T22:12:12-04:00">2024-03-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/BabylonJS/" itemprop="url" rel="index">
                    <span itemprop="name">BabylonJS</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>655</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Default-World"><a href="#Default-World" class="headerlink" title="Default World"></a>Default World</h1><h2 id="Create-Default-Camera"><a href="#Create-Default-Camera" class="headerlink" title="Create Default Camera"></a>Create Default Camera</h2><p>The <code>createDefaultCamera</code> takes three boolean parameters, all set to <em>false</em> by default. They are</p>
<ul>
<li>createArcRotateCamera: creates a free camera by default and an arc rotate camera when <em>true</em>;</li>
<li>replace: when <em>true</em> the created camera will replace the existing active one;</li>
<li>attachCameraControls: when <em>true</em> attaches control to the canvas.</li>
</ul>
<p>This code will create an arc rotate camera, replace any existing camera and attach the camera control to the canvas</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scene.createDefaultCamera(<span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<h2 id="Create-Default-Light"><a href="#Create-Default-Light" class="headerlink" title="Create Default Light"></a>Create Default Light</h2><p>The <code>createDefaultLight</code> takes just one boolean parameters, set to <em>false</em> by default:</p>
<ul>
<li>replace: when <em>true</em> the created light will replace all the existing ones; when <em>false</em> and there are no existing lights a hemispherical light is created; when <em>false</em> and lights already exist, no change is made to the scene which means no light will add to the scene.</li>
</ul>
<p>When this method is used before the creation of any other lights then it is usually sufficient to use</p>
<h2 id="Create-Default-Environment"><a href="#Create-Default-Environment" class="headerlink" title="Create Default Environment"></a>Create Default Environment</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> environment = scene.createDefaultEnvironment(options);</span><br></pre></td></tr></table></figure>
<p>adds a skybox and ground to the scene, sets a wide range of environmental parameters and returns an environmental helper to the scene. See more options in the  <a target="_blank" rel="noopener" href="https://doc.babylonjs.com/typedoc/interfaces/BABYLON.IEnvironmentHelperOptions">API Doc</a></p>
<h2 id="Create-Default-SkyBox"><a href="#Create-Default-SkyBox" class="headerlink" title="Create Default SkyBox"></a>Create Default SkyBox</h2><p>The <code>createDefaultSkybox</code> method can be used when you do not want to create a full environment</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> texture = <span class="keyword">new</span> BABYLON.CubeTexture(<span class="string">&quot;path/to/texture&quot;</span>, scene);</span><br><span class="line">scene.createDefaultSkybox(texture, <span class="literal">true</span>, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>
<p>In this case the first two parameters used give the texture for the skybox and specify that <a target="_blank" rel="noopener" href="https://doc.babylonjs.com/features/featuresDeepDive/materials/using/introToPBR">a PBRMaterial</a> is to be used (second parameter, <em>true</em>) as opposed to a standard material (second parameter, <em>false</em> - default value).</p>
<p>The third parameter defines the scale of your skybox (this value depends on the scale of your scene), the default value is <em>1000</em>.</p>
<h2 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h2><p>Since the <code>createDefault...</code> helpers take into account any models in the scene to calculate parameter like scale and position, so it’s a good practice to createDefaultXXX after creating all models.</p>
<h1 id="Interacting-With-Scenes"><a href="#Interacting-With-Scenes" class="headerlink" title="Interacting With Scenes"></a>Interacting With Scenes</h1><h2 id="Keyboard-Interactions"><a href="#Keyboard-Interactions" class="headerlink" title="Keyboard Interactions"></a>Keyboard Interactions</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">scene.onKeyboardObservable.add(<span class="function">(<span class="params">kbInfo</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (kbInfo.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> BABYLON.KeyboardEventTypes.KEYDOWN:</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;KEY DOWN: &quot;</span>, kbInfo.event.key);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> BABYLON.KeyboardEventTypes.KEYUP:</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;KEY UP: &quot;</span>, kbInfo.event.code);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Pointer-Interactions"><a href="#Pointer-Interactions" class="headerlink" title="Pointer Interactions"></a>Pointer Interactions</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">scene.onPointerObservable.add(<span class="function">(<span class="params">pointerInfo</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (pointerInfo.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> BABYLON.PointerEventTypes.POINTERDOWN:</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;POINTER DOWN&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> BABYLON.PointerEventTypes.POINTERUP:</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;POINTER UP&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> BABYLON.PointerEventTypes.POINTERMOVE:</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;POINTER MOVE&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> BABYLON.PointerEventTypes.POINTERWHEEL:</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;POINTER WHEEL&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> BABYLON.PointerEventTypes.POINTERPICK:</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;POINTER PICK&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> BABYLON.PointerEventTypes.POINTERTAP:</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;POINTER TAP&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> BABYLON.PointerEventTypes.POINTERDOUBLETAP:</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;POINTER DOUBLE-TAP&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="Using-Multiple-Scenes"><a href="#Using-Multiple-Scenes" class="headerlink" title="Using Multiple Scenes"></a>Using Multiple Scenes</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> scene0 = <span class="keyword">new</span> BABYLON.Scene(engine);</span><br><span class="line"><span class="keyword">var</span> scene1 = <span class="keyword">new</span> BABYLON.Scene(engine);</span><br><span class="line"></span><br><span class="line">engine.runRenderLoop(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  scene0.render();</span><br><span class="line">  scene1.render(); <span class="comment">// scene1 will erase scene0</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Remeber that each <code>scene.render</code> call will try to clear what has been rendered before, and to avoid one scene erasing what another has rendered, you need to set <code>scene.autoClear = false</code> on all the scenes rendered on “top” of others:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> scene0 = <span class="keyword">new</span> BABYLON.Scene(engine);</span><br><span class="line"><span class="keyword">var</span> scene1 = <span class="keyword">new</span> BABYLON.Scene(engine);</span><br><span class="line">scene1.autoClear = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">engine.runRenderLoop(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  scene0.render();</span><br><span class="line">  scene1.render();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="Applying-Delta-Changes-To-A-Scene"><a href="#Applying-Delta-Changes-To-A-Scene" class="headerlink" title="Applying Delta Changes To A Scene"></a>Applying Delta Changes To A Scene</h1><p> This means you can “record” all changes done to a scene and later on reapply these changes.</p>
<p>This is particularly useful when you load a scene from a .babylon or a .gltf file and you want to apply changes to it</p>
<h2 id="Recording-the-changes"><a href="#Recording-the-changes" class="headerlink" title="Recording the changes"></a>Recording the changes</h2><p>To record changes done to a scene, you simply have to create a new <code>SceneRecorder</code> and call its <code>track()</code> function:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> recorder = <span class="keyword">new</span> BABYLON.SceneRecorder();</span><br><span class="line"></span><br><span class="line">recorder.track(scene);</span><br></pre></td></tr></table></figure>
<p>This will mark the origin of the changes eg. the original state of your scene. Every changes (well, almost actually, please check the limitations chapter below) made after that call will be tracked and available in the delta file.</p>
<h2 id="Applying-the-changes"><a href="#Applying-the-changes" class="headerlink" title="Applying the changes"></a>Applying the changes</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> delta = recorder.getDelta();</span><br><span class="line">BABYLON.Tools.Download(<span class="built_in">JSON</span>.stringify(delta), <span class="string">&quot;delta.json&quot;</span>); <span class="comment">// download changes</span></span><br><span class="line">BABYLON.SceneRecorder.ApplyDelta(delta, scene); <span class="comment">// apply changes</span></span><br></pre></td></tr></table></figure>
<h2 id="Limitations"><a href="#Limitations" class="headerlink" title="Limitations"></a>Limitations</h2><p>The recorder has some limitations listed here:</p>
<ul>
<li>It will only record simple values (array, colors, vectors, boolean, number)</li>
<li>It will not record large state changes like:<ul>
<li>Updating the material property of a mesh</li>
<li>Updating the skeleton property of a mesh</li>
<li>Updating mesh’s geometry</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://swordandtea.github.io/2024/03/14/babylonJS/light/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="SwordAndTea">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiangwei's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/14/babylonJS/light/" class="post-title-link" itemprop="url">light</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-03-14 12:11:37" itemprop="dateCreated datePublished" datetime="2024-03-14T12:11:37-04:00">2024-03-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-03-27 20:51:20" itemprop="dateModified" datetime="2024-03-27T20:51:20-04:00">2024-03-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/BabylonJS/" itemprop="url" rel="index">
                    <span itemprop="name">BabylonJS</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>The default number of lights allowed is four but this can be increased.</p>
<p>There are four types of lights that can be used with a range of lighting properties.</p>
<ul>
<li>The Point Light - think light bulb.</li>
<li>The Directional Light - think planet lit by a distant sun.</li>
<li>The Spot Light - think of a focused beam of light.</li>
<li>The Hemispheric Light - think of the ambient light.</li>
</ul>
<p>Color properties for all lights include <em>emissive</em>, <em>diffuse</em> and <em>specular</em>.</p>
<p>Overlapping lights will interact as you would expect with the overlap of red, green and blue producing white light. Every light can be switched on or off and when on its intensity can be set with a value from 0 to 1.</p>
<p> All meshes allow light to pass through them unless shadow generation is activated.</p>
<h1 id="Types-of-Lights"><a href="#Types-of-Lights" class="headerlink" title="Types of Lights"></a>Types of Lights</h1><h2 id="Point-Light"><a href="#Point-Light" class="headerlink" title="Point Light"></a>Point Light</h2><p>A point light is a light defined by an unique point in world space. The light is emitted in <font color="orange">every direction</font> from this point. A good example of a point light is a standard light bulb.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> light = <span class="keyword">new</span> BABYLON.PointLight(<span class="string">&quot;pointLight&quot;</span>, <span class="keyword">new</span> BABYLON.Vector3(<span class="number">1</span>, <span class="number">10</span>, <span class="number">1</span>), scene);</span><br></pre></td></tr></table></figure>
<h2 id="Directional-Light"><a href="#Directional-Light" class="headerlink" title="Directional Light"></a>Directional Light</h2><p>A directional light is defined by a direction. The light is emitted from <font color="orange">everywhere</font> in the specified direction, and has an <font color="orange">infinite range</font>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> light = <span class="keyword">new</span> BABYLON.DirectionalLight(<span class="string">&quot;DirectionalLight&quot;</span>, <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, -<span class="number">1</span>, <span class="number">0</span>), scene);</span><br></pre></td></tr></table></figure>
<h2 id="Spot-Light"><a href="#Spot-Light" class="headerlink" title="Spot Light"></a>Spot Light</h2><p>A spot light is defined by a position, a direction, an angle, and an exponent. These values define a cone of light starting from the position, emitting toward the direction.</p>
<p>The angle, in radians, defines the size (field of illumination) of the spotlight’s conical beam , and the exponent defines the speed of the decay of the light with distance (reach).</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> light = <span class="keyword">new</span> BABYLON.SpotLight(<span class="string">&quot;spotLight&quot;</span>, <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">30</span>, -<span class="number">10</span>), <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, -<span class="number">1</span>, <span class="number">0</span>), <span class="built_in">Math</span>.PI / <span class="number">3</span>, <span class="number">2</span>, scene);</span><br></pre></td></tr></table></figure>
<h2 id="Hemispheric-Light"><a href="#Hemispheric-Light" class="headerlink" title="Hemispheric Light"></a>Hemispheric Light</h2><p>A hemispheric light is an easy way to simulate an ambient environment light. A hemispheric light is defined by a direction, usually ‘up’ towards the sky. However it is by setting the color properties that the full effect is achieved.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> light = <span class="keyword">new</span> BABYLON.HemisphericLight(<span class="string">&quot;HemiLight&quot;</span>, <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>), scene);</span><br></pre></td></tr></table></figure>
<h1 id="Color-Properties"><a href="#Color-Properties" class="headerlink" title="Color Properties"></a>Color Properties</h1><p>There are three properties of lights that affect color. Two of these <em>diffuse</em> and <em>specular</em> apply to all four types of light, the third, <em>groundColor</em>, only applies to an Hemispheric Light.</p>
<ol>
<li>Diffuse gives the basic color to an object;</li>
<li>Specular produces a highlight color on an object.</li>
</ol>
<h1 id="Limitations"><a href="#Limitations" class="headerlink" title="Limitations"></a>Limitations</h1><p>a single material can only handle a defined number simultaneous lights (by default this value is equal to 4 which means the first four enabled lights of the scene’s lights list). You can change this number with this code</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> material = <span class="keyword">new</span> BABYLON.StandardMaterial(<span class="string">&quot;mat&quot;</span>, scene);</span><br><span class="line">material.maxSimultaneousLights = <span class="number">6</span>;</span><br></pre></td></tr></table></figure>
<h1 id="On-Off-or-Dimmer"><a href="#On-Off-or-Dimmer" class="headerlink" title="On, Off or Dimmer"></a>On, Off or Dimmer</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">light.setEnabled(<span class="literal">false</span>); <span class="comment">// off</span></span><br><span class="line">light.setEnabled(<span class="literal">true</span>); <span class="comment">// on</span></span><br><span class="line">light.intensity = <span class="number">0.5</span>; <span class="comment">// dimmer, default value is 1</span></span><br><span class="line">light.intensity = <span class="number">2.4</span>; <span class="comment">// brighter, default value is 1</span></span><br></pre></td></tr></table></figure>
<p>For point and spot lights you can set how far the light reaches using the <em>range</em> property</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">light.range = <span class="number">100</span>; </span><br></pre></td></tr></table></figure>
<h1 id="Choosing-Meshes-to-Light"><a href="#Choosing-Meshes-to-Light" class="headerlink" title="Choosing Meshes to Light"></a>Choosing Meshes to Light</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">light.excludedMeshes.push(someMesh)</span><br><span class="line">light.includedOnlyMeshes.push(someMesh)</span><br></pre></td></tr></table></figure>
<h1 id="Shadows"><a href="#Shadows" class="headerlink" title="Shadows"></a>Shadows</h1><p>Shadows are easy to generate using the Babylon.js <code>ShadowGenerator</code>. This function uses a shadow map: a map of your scene generated from the light’s point of view.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> shadowGenerator = <span class="keyword">new</span> BABYLON.ShadowGenerator(<span class="number">1024</span>, light);</span><br></pre></td></tr></table></figure>
<p>The two parameters used by the shadow generator are: the size of the shadow map (which determines the shadow detail level), and which light is used for the shadow map’s computation. </p>
<p>Next, you have to define which shadows will be rendered:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shadowGenerator.getShadowMap().renderList.push(mesh);</span><br></pre></td></tr></table></figure>
<p>And finally, you will have to define where the shadows will be displayed by setting a mesh parameter to true:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">someMesh.receiveShadows = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="Soft-shadows"><a href="#Soft-shadows" class="headerlink" title="Soft shadows"></a>Soft shadows</h2><p>If you want to go further, you can activate shadows filtering in order to create better looking shadows by removing the hard edges: </p>
<h3 id="Possion-sampling"><a href="#Possion-sampling" class="headerlink" title="Possion sampling"></a>Possion sampling</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shadowGenerator.usePoissonSampling = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>If you set this one to <code>true</code>, Variance shadow maps will be disabled. This filter uses Poisson sampling to soften shadows. <font color="orange">The result is better, but slower</font>.</p>
<h3 id="Exponential-shadow-map"><a href="#Exponential-shadow-map" class="headerlink" title="Exponential shadow map"></a>Exponential shadow map</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shadowGenerator.useExponentialShadowMap = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>It is <code>true</code> by default, because it is useful to decrease the aliasing of the shadow.  But if you want to reduce computation time, feel free to turn it off. You can also control how the exponential shadow map scales depth values by changing the <code>shadowGenerator.depthScale</code>. By default, the value is 50.0 but you may want to change it if the depth scale of your world (the distance between MinZ and MaxZ) is small.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shadowGenerator.depthScale = <span class="number">25.0</span></span><br></pre></td></tr></table></figure>
<h3 id="Blur-exponential-shadow-map"><a href="#Blur-exponential-shadow-map" class="headerlink" title="Blur exponential shadow map"></a>Blur exponential shadow map</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shadowGenerator.useBlurExponentialShadowMap = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h3 id="Close-exponential-shadow-map"><a href="#Close-exponential-shadow-map" class="headerlink" title="Close exponential shadow map"></a>Close exponential shadow map</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shadowGenerator.useCloseExponentialShadowMap = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>The Close Exponential Shadow Map is a way of doing exponential shadow map to deal with self-shadowing issues</p>
<h3 id="Percentage-Close-Filtering"><a href="#Percentage-Close-Filtering" class="headerlink" title="Percentage Close Filtering"></a>Percentage Close Filtering</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shadowGenerator.usePercentageCloserFiltering = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h2 id="Transparent-Objects-shadows"><a href="#Transparent-Objects-shadows" class="headerlink" title="Transparent Objects shadows"></a>Transparent Objects shadows</h2><p>For transparent objects to cast shadows, you must set the <code>transparencyShadow</code> property to <code>true</code> on the shadow generator:</p>
<p>Starting with Babylonjs v4.2, you can simulate soft transparent shadows for transparent objects. To do this, you need to set the <code>enableSoftTransparentShadow</code> property to <code>true</code> on the shadow generator:</p>
<h2 id="Lights"><a href="#Lights" class="headerlink" title="Lights"></a>Lights</h2><p>Keep in mind that <font color="orange">one shadow generator can only be used with one light.</font> If you want to generate shadows from another light, then you will need to create another shadow generator.</p>
<font color="orange">Only point, directional and spot lights can cast shadows.</font>

<h3 id="Point-Lights"><a href="#Point-Lights" class="headerlink" title="Point Lights"></a>Point Lights</h3><p>Point lights use cubemaps rendering</p>
<p><code>BlurExponentialShadowMap</code> and <code>CloseBlurExponentialShadowMap</code> are not supported by point lights (mostly because blurring the six faces of the cubemap would be too expensive).</p>
<h3 id="Spot-lights"><a href="#Spot-lights" class="headerlink" title="Spot lights"></a>Spot lights</h3><p>Spot lights use perspective projection to compute the shadow map.</p>
<h3 id="Directional-lights"><a href="#Directional-lights" class="headerlink" title="Directional lights"></a>Directional lights</h3><p>Directional lights use orthogonal projection.</p>
<font color="orange">The light's position of directional light can determine where the shadows will appear, even though by defination, drectional light is emitted from everywhere in the specified direction, and has an infinite range.</font>

<p>The light position is set as being <code>-light.direction</code> at creation time</p>
<p>You can also set <code>light.autoCalcShadowZBounds = true</code> to compute automatically the best <code>light.shadowMinZ</code> and <code>light.shadowMaxZ</code> values for each frame. Tightening those values to best fit your scene improve the precision of the depth map, and consequently the shadow rendering. Be warned, however, that when using this parameter with PCF and PCSS you may miss some shadows because of the way those filtering technics are implemented. Note that <code>light.autoUpdateExtends</code> must be set to <code>true</code> for <code>light.autoCalcShadowZBounds</code> to work.</p>
<p>By default, the x and y extents of the light frustum (the position of the left/right/top/bottom planes of the frustum) are automatically computed by Babylon because <code>light.autoUpdateExtends = true</code>. You can set this property to <code>false</code> and set the frustum sizes manually by updating the <code>orthoLeft</code>, <code>orthoRight</code>, <code>orthoTop</code> and <code>orthoBottom</code> properties. You can use the <code>shadowFrustumSize</code> property instead if you want to set the frustum with a fixed size in all dimensions.</p>
<p>The values for the near/far planes are stored in <code>shadowMinZ</code> and <code>shadowMaxZ</code>, properties that you can change (as in the PG). You can also let Babylon compute them automatically by setting <code>light.autoCalcShadowZBounds = true</code> (<code>false</code> by default). Note that when Babylon computes the bounds automatically, it does so by taking into account only the objects that are shadow casters! That’s why if you activate it in the PG, you will see that the light frustum does not encompass the ground, which is not a shadow caster but only a receiver.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://swordandtea.github.io/2024/03/14/babylonJS/camera/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="SwordAndTea">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiangwei's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/14/babylonJS/camera/" class="post-title-link" itemprop="url">camera</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-03-14 12:11:16" itemprop="dateCreated datePublished" datetime="2024-03-14T12:11:16-04:00">2024-03-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-03-17 23:56:27" itemprop="dateModified" datetime="2024-03-17T23:56:27-04:00">2024-03-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/BabylonJS/" itemprop="url" rel="index">
                    <span itemprop="name">BabylonJS</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>920</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Cameras"><a href="#Cameras" class="headerlink" title="Cameras"></a>Cameras</h1><p>To allow user input, a camera must be attached to the canvas using:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">camera.attachControl(canvas, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>The second parameter is optional and defaults to <code>false</code>, which prevents default actions on a canvas event. Set to <code>true</code> to allow canvas default actions.</p>
<h2 id="Universal-Camera"><a href="#Universal-Camera" class="headerlink" title="Universal Camera"></a>Universal Camera</h2><p>This camera is controlled by the keyboard, mouse, touch, or gamepad depending on the input device used, with no need for the controller to be specified. The UniversalCamera has the same functionality as Free Camera but also adds built-in support for Touch and Gamepads.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Parameters : name, position, scene</span></span><br><span class="line"><span class="keyword">const</span> camera = <span class="keyword">new</span> BABYLON.UniversalCamera(<span class="string">&quot;name&quot;</span>, <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">0</span>, -<span class="number">10</span>), scene);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Targets the camera to a particular position</span></span><br><span class="line">camera.setTarget(BABYLON.Vector3.Zero());</span><br><span class="line"></span><br><span class="line"><span class="comment">// Attach the camera to the canvas</span></span><br><span class="line">camera.attachControl(canvas, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<h2 id="Arc-Rotate-Camera"><a href="#Arc-Rotate-Camera" class="headerlink" title="Arc Rotate Camera"></a>Arc Rotate Camera</h2><p>This camera always points towards a given target position and can be rotated around that target with the target as the center of rotation. It can be controlled with cursors and mouse, or with touch events.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Parameters: name, alpha, beta, radius, target position, scene</span></span><br><span class="line"><span class="keyword">const</span> camera = <span class="keyword">new</span> BABYLON.ArcRotateCamera(<span class="string">&quot;Camera&quot;</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), scene);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Positions the camera overwriting alpha, beta, radius</span></span><br><span class="line">camera.setPosition(<span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">20</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// This attaches the camera to the canvas</span></span><br><span class="line">camera.attachControl(canvas, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<h2 id="Follow-Camera"><a href="#Follow-Camera" class="headerlink" title="Follow Camera"></a>Follow Camera</h2><p>Give it a mesh as a target, and from whatever position it is currently at, this camera will move to a goal position from which to view the target. When the target moves, so will the Follow Camera.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Parameters: name, position, scene</span></span><br><span class="line"><span class="keyword">const</span> camera = <span class="keyword">new</span> BABYLON.FollowCamera(<span class="string">&quot;FollowCam&quot;</span>, <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">10</span>, -<span class="number">10</span>), scene);</span><br><span class="line"></span><br><span class="line"><span class="comment">// The goal distance of camera from target</span></span><br><span class="line">camera.radius = <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The goal height of camera above local origin (centre) of target</span></span><br><span class="line">camera.heightOffset = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The goal rotation of camera around local origin (centre) of target in x y plane</span></span><br><span class="line">camera.rotationOffset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Acceleration of camera in moving from current to goal position</span></span><br><span class="line">camera.cameraAcceleration = <span class="number">0.005</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The speed at which acceleration is halted</span></span><br><span class="line">camera.maxCameraSpeed = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This attaches the camera to the canvas</span></span><br><span class="line">camera.attachControl(canvas, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span>: SET CAMERA TARGET AFTER THE TARGET&#x27;S CREATION AND NOTE CHANGE FROM BABYLONJS V 2.5</span></span><br><span class="line"><span class="comment">// targetMesh created here.</span></span><br><span class="line">camera.target = targetMesh; <span class="comment">// version 2.4 and earlier</span></span><br><span class="line">camera.lockedTarget = targetMesh; <span class="comment">//version 2.5 onwards</span></span><br></pre></td></tr></table></figure>
<h2 id="Anaglyph-Camera"><a href="#Anaglyph-Camera" class="headerlink" title="Anaglyph Camera"></a>Anaglyph Camera</h2><p>The <a target="_blank" rel="noopener" href="https://doc.babylonjs.com/typedoc/classes/babylon.anaglyphuniversalcamera">AnaglyphUniversalCamera</a> and <a target="_blank" rel="noopener" href="https://doc.babylonjs.com/typedoc/classes/babylon.anaglypharcrotatecamera">AnaglyphArcRotateCamera</a> extend the use of the Universal and Arc Rotate Cameras for use with red and cyan 3D glasses. They use post-processing filtering techniques.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Parameters : name, position, eyeSpace, scene</span></span><br><span class="line"><span class="keyword">const</span> camera = <span class="keyword">new</span> BABYLON.AnaglyphUniversalCamera(<span class="string">&quot;af_cam&quot;</span>, <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">1</span>, -<span class="number">15</span>), <span class="number">0.033</span>, scene);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Parameters : name, alpha, beta, radius, target, eyeSpace, scene</span></span><br><span class="line"><span class="keyword">const</span> camera = <span class="keyword">new</span> BABYLON.AnaglyphArcRotateCamera(<span class="string">&quot;aar_cam&quot;</span>, -<span class="built_in">Math</span>.PI / <span class="number">2</span>, <span class="built_in">Math</span>.PI / <span class="number">4</span>, <span class="number">20</span>, BABYLON.Vector3.Zero(), <span class="number">0.033</span>, scene);</span><br></pre></td></tr></table></figure>
<p>The <code>eyeSpace</code> parameter sets the amount of shift between the left-eye view and the right-eye view. Once you are wearing your 3D glasses, you might want to experiment with this float value.</p>
<h2 id="Device-Orientation-Camera"><a href="#Device-Orientation-Camera" class="headerlink" title="Device Orientation Camera"></a>Device Orientation Camera</h2><p>The <a target="_blank" rel="noopener" href="https://doc.babylonjs.com/typedoc/classes/babylon.deviceorientationcamera">DeviceOrientationCamera</a> is specifically designed to react to device orientation events such as a modern mobile device being tilted forward, back, left, or right.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Parameters : name, position, scene</span></span><br><span class="line"><span class="keyword">const</span> camera = <span class="keyword">new</span> BABYLON.DeviceOrientationCamera(<span class="string">&quot;DevOr_camera&quot;</span>, <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), scene);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Targets the camera to a particular position</span></span><br><span class="line">camera.setTarget(<span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">0</span>, -<span class="number">10</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sets the sensitivity of the camera to movement and rotation</span></span><br><span class="line">camera.angularSensibility = <span class="number">10</span>;</span><br><span class="line">camera.moveSensibility = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Attach the camera to the canvas</span></span><br><span class="line">camera.attachControl(canvas, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<h2 id="Fly-Camera"><a href="#Fly-Camera" class="headerlink" title="Fly Camera"></a>Fly Camera</h2><p>FlyCamera imitates free movement in 3D space, think “a ghost in space.” It comes with an option to gradually correct Roll, and also an option to mimic banked-turns.</p>
<p>Its defaults are:</p>
<ol>
<li><p>Keyboard - The A and D keys move the camera left and right. The W and S keys move it forward and backward. The E and Q keys move it up and down.</p>
</li>
<li><p>Mouse - Rotates the camera about the Pitch and Yaw (X, Y) axes with the camera as the origin. Holding the right mouse button rotates the camera about the Roll (Z) axis with the camera as the origin.</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> camera = <span class="keyword">new</span> BABYLON.FlyCamera(<span class="string">&quot;FlyCamera&quot;</span>, <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">5</span>, -<span class="number">10</span>), scene);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Airplane like rotation, with faster roll correction and banked-turns.</span></span><br><span class="line"><span class="comment">// Default is 100. A higher number means slower correction.</span></span><br><span class="line">camera.rollCorrect = <span class="number">10</span>;</span><br><span class="line"><span class="comment">// Default is false.</span></span><br><span class="line">camera.bankedTurn = <span class="literal">true</span>;</span><br><span class="line"><span class="comment">// Defaults to 90° in radians in how far banking will roll the camera.</span></span><br><span class="line">camera.bankedTurnLimit = <span class="built_in">Math</span>.PI / <span class="number">2</span>;</span><br><span class="line"><span class="comment">// How much of the Yawing (turning) will affect the Rolling (banked-turn.)</span></span><br><span class="line"><span class="comment">// Less than 1 will reduce the Rolling, and more than 1 will increase it.</span></span><br><span class="line">camera.bankedTurnMultiplier = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This attaches the camera to the canvas</span></span><br><span class="line">camera.attachControl(canvas, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<h1 id="Camera-Collisions"><a href="#Camera-Collisions" class="headerlink" title="Camera Collisions"></a>Camera Collisions</h1><h2 id="Define-and-apply-gravity"><a href="#Define-and-apply-gravity" class="headerlink" title="Define and apply gravity"></a>Define and apply gravity</h2><p>In the real world, gravity is a <em>force</em> (ok, sort of) that is exerted downward — <em>i.e.</em>, in a negative direction along the Y-axis. On Earth, this force is roughly 9.81m/s². Falling bodies <em>accelerate</em> as they fall, so it takes 1 second to fully reach this velocity, then the velocity reaches 19.62m/s after 2 seconds, 29.43m/s after 3 seconds, etc. In an atmosphere, wind drag eventually matches this force and velocity ceases to increase (“terminal velocity”).</p>
<p>Babylon.js follows a much simpler gravitational model, however — <code>scene.gravity</code> represents a <em>constant velocity</em>, not a force of acceleration, and it is measured in <em>units/frame</em> rather than <em>meters/second</em>. As each frame is rendered, the cameras you apply this gravity to will <em>move</em> by the vector’s value along each axis (usually <code>x</code> and <code>z</code> are set to 0, but you can have “gravity” in any direction!), until a collision is detected.</p>
<p>If you need a more accurate representation of gravitational (or other) forces, you can use the physics engines</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="SwordAndTea"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">SwordAndTea</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">132</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/SwordAndTea" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;SwordAndTea" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">SwordAndTea</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">215k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">11:56</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v5.4.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.7.1
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      
<script type="text/x-mathjax-config">

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });

  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') {
          next = next.nextSibling;
        }
        if (next && next.nodeName.toLowerCase() === 'br') {
          next.parentNode.removeChild(next);
        }
      }
    });
  });

  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      element = document.getElementById(all[i].inputID + '-Frame').parentNode;
      if (element.nodeName.toLowerCase() == 'li') {
        element = element.parentNode;
      }
      element.classList.add('has-jax');
    }
  });
</script>
<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML', () => {
    MathJax.Hub.Typeset();
  }, window.MathJax);
</script>

    

  

</body>
</html>
